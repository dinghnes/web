<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°½é€€æé†’å°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .clock-shadow {
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* ç°¡å–®çš„è„ˆè¡å‹•ç•« */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .active-pulse {
            animation: pulse-ring 2s infinite;
        }
        /* æŒ‰éˆ•é»æ“Šæ•ˆæœ */
        .btn-press:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 md:p-8 relative overflow-hidden">
        <!-- é ‚éƒ¨è£é£¾æ¢ -->
        <div class="absolute top-0 left-0 w-full h-2 bg-blue-600"></div>

        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">è¥¿å¯§åœ‹å°åŠ ç­ç°½é€€æé†’</h1>
            <p class="text-gray-500 text-sm mt-1">è‡ºä¸­å¸‚ç«‹å­¸æ ¡å·®å‹¤ç³»çµ±</p>
        </div>

        <!-- æ™‚é–“é¡¯ç¤º -->
        <div class="bg-gray-900 rounded-xl p-6 text-center mb-6 text-white shadow-inner relative overflow-hidden group">
            <div class="absolute inset-0 bg-blue-500 opacity-0 group-hover:opacity-5 transition-opacity duration-500"></div>
            <p class="text-gray-400 text-sm mb-1">ç¾åœ¨æ™‚é–“</p>
            <div id="current-clock" class="text-5xl font-mono font-bold tracking-wider clock-shadow tabular-nums">00:00:00</div>
            <div id="current-date" class="text-blue-300 text-sm mt-2 font-medium">Loading...</div>
        </div>

        <!-- è¨­å®šå€åŸŸ -->
        <div class="space-y-4">
            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200 transition-colors hover:border-blue-300">
                <div class="flex items-center">
                    <i class="fas fa-clock text-blue-600 mr-3 text-xl w-6 text-center"></i>
                    <div>
                        <label for="target-time" class="block text-sm font-bold text-gray-700">è¨­å®šæé†’æ™‚é–“</label>
                        <p class="text-xs text-gray-500">æ ¼å¼ï¼š24å°æ™‚åˆ¶</p>
                    </div>
                </div>
                <input type="time" id="target-time" value="08:10" class="bg-white border border-gray-300 rounded px-2 py-1 text-lg font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
            </div>

            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200 hover:border-blue-300 transition-colors">
                <div class="flex items-center">
                    <i class="fas fa-volume-up text-yellow-500 mr-3 text-xl w-6 text-center"></i>
                    <span class="text-sm font-bold text-gray-700">å•Ÿç”¨éŸ³æ•ˆèˆ‡å½ˆçª—</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="sound-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
            
            <!-- å¿«é€Ÿé€£çµèˆ‡æ¸¬è©¦ -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="testAlarm()" class="btn-press bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-lg transition duration-300 flex items-center justify-center gap-2 border border-gray-200">
                    <i class="fas fa-vial text-gray-500"></i> æ¸¬è©¦æé†’
                </button>
                <a href="https://pemis.taichung.gov.tw/index.aspx" target="_blank" class="btn-press bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-300 shadow-md flex items-center justify-center gap-2">
                    <i class="fas fa-external-link-alt"></i>
                    æ‰‹å‹•å‰å¾€
                </a>
            </div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤º -->
        <div id="status-msg" class="mt-6 text-center text-sm text-gray-500 bg-blue-50 py-2 rounded border border-blue-100 flex items-center justify-center gap-2">
            <i class="fas fa-spinner fa-spin text-blue-400"></i> <span>æ­£åœ¨ç›£æ§æ™‚é–“ä¸­...</span>
        </div>

        <div class="mt-6 text-xs text-gray-400 text-center space-y-1">
            <p>â€» è«‹ä¿æŒæ­¤åˆ†é é–‹å•Ÿä»¥æ¥æ”¶æé†’</p>
            <p>â€» å»ºè­°å…è¨±æ­¤ç¶²ç«™çš„ã€Œé€šçŸ¥ã€æ¬Šé™</p>
        </div>
    </div>

    <!-- æé†’ Modal -->
    <div id="alarm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden flex items-center justify-center z-50 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center active-pulse transform transition-all scale-100 mx-4">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-5 animate-bounce">
                <i class="fas fa-clock text-red-600 text-4xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ç°½é€€æ™‚é–“åˆ°äº†ï¼</h2>
            <p class="text-gray-600 mb-6 text-lg">ç¾åœ¨æ˜¯ <span id="alarm-time-display" class="font-bold font-mono text-red-500"></span></p>
            
            <p id="popup-blocked-msg" class="hidden text-xs text-left text-red-600 mb-4 bg-red-50 p-3 rounded border border-red-100">
                <i class="fas fa-exclamation-triangle mr-1"></i> <strong>æ³¨æ„ï¼š</strong>è‡ªå‹•é–‹å•Ÿç¶²é è¢«ç€è¦½å™¨æ””æˆªã€‚<br>è«‹é»æ“Šä¸‹æ–¹è—è‰²æŒ‰éˆ•å‰å¾€ç³»çµ±ã€‚
            </p>

            <div class="space-y-3">
                <a href="https://pemis.taichung.gov.tw/index.aspx" target="_blank" onclick="stopAlarm()" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg transition shadow-lg transform hover:-translate-y-1">
                    <i class="fas fa-sign-out-alt mr-2"></i> ç«‹å³å‰å¾€ç°½é€€ç³»çµ±
                </a>
                <button onclick="stopAlarm()" class="block w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-lg transition border border-gray-300">
                    ç¨å¾Œå†èªª
                </button>
            </div>
        </div>
    </div>

    <script>
        // è®Šæ•¸åˆå§‹åŒ–
        const clockElement = document.getElementById('current-clock');
        const dateElement = document.getElementById('current-date');
        const targetTimeInput = document.getElementById('target-time');
        const soundToggle = document.getElementById('sound-toggle');
        const statusMsg = document.getElementById('status-msg');
        const alarmModal = document.getElementById('alarm-modal');
        const popupBlockedMsg = document.getElementById('popup-blocked-msg');
        
        let alarmTriggeredToday = false;
        let audioCtx = null;
        let titleInterval = null;
        const originalTitle = document.title;
        const targetUrl = "https://pemis.taichung.gov.tw/index.aspx";

        // è«‹æ±‚ç€è¦½å™¨é€šçŸ¥æ¬Šé™
        if ("Notification" in window) {
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        // æ¨™é¡Œé–ƒçˆåŠŸèƒ½
        function startTitleFlash(text) {
            if (titleInterval) clearInterval(titleInterval);
            let isOriginal = false;
            titleInterval = setInterval(() => {
                document.title = isOriginal ? originalTitle : text;
                isOriginal = !isOriginal;
            }, 1000);
        }

        function stopTitleFlash() {
            if (titleInterval) {
                clearInterval(titleInterval);
                titleInterval = null;
            }
            document.title = originalTitle;
        }

        // æ’­æ”¾æç¤ºéŸ³
        function playBeep() {
            if (!soundToggle.checked) return;

            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                // æ¢å¾© Context
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.exponentialRampToValueAtTime(1046.5, audioCtx.currentTime + 0.1); // C6
                
                // é›™é‡å—¶è²
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime + 0.4);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 1.0);
            } catch (e) {
                console.error("Audio play failed", e);
            }
        }

        function testAlarm() {
            // æ¸¬è©¦æ™‚ä¸æª¢æŸ¥æ™‚é–“ï¼Œç›´æ¥è§¸ç™¼
            showAlarm(true);
        }

        function showAlarm(isTest = false) {
            playBeep();
            
            // 1. é¡¯ç¤º HTML Modal (é é¢å…§é®ç½©)
            document.getElementById('alarm-time-display').innerText = new Date().toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'});
            alarmModal.classList.remove('hidden');
            popupBlockedMsg.classList.add('hidden'); // å…ˆé‡ç½®éŒ¯èª¤è¨Šæ¯

            // 2. æ¨™é¡Œé–ƒçˆ
            startTitleFlash("ğŸ”´ ç°½é€€æ™‚é–“åˆ°äº†ï¼");

            // 3. ç€è¦½å™¨ç³»çµ±é€šçŸ¥
            if (Notification.permission === "granted") {
                const notify = new Notification("ç°½é€€æé†’", {
                    body: isTest ? "é€™æ˜¯æ¸¬è©¦æé†’ï¼" : "æ™‚é–“åˆ°äº†ï¼è«‹å‰å¾€å°ä¸­å¸‚æ”¿åºœäººäº‹ç³»çµ±ç°½é€€ã€‚",
                    icon: "https://pemis.taichung.gov.tw/favicon.ico",
                    requireInteraction: true
                });
                notify.onclick = function() {
                    window.open(targetUrl, '_blank');
                    window.focus();
                    stopAlarm();
                };
            }

            // 4. å˜—è©¦è‡ªå‹•é–‹å•Ÿç¶²é 
            // æ³¨æ„ï¼šç¾ä»£ç€è¦½å™¨é€šå¸¸æœƒé˜»æ“‹éç”¨æˆ¶è§¸ç™¼çš„ window.open
            if (!isTest) {
                try {
                    const newWin = window.open(targetUrl, '_blank');
                    if (!newWin || newWin.closed || typeof newWin.closed == 'undefined') {
                        // å¦‚æœè¢«æ””æˆª
                        console.log("Popup blocked by browser");
                        popupBlockedMsg.classList.remove('hidden');
                    }
                } catch (e) {
                    popupBlockedMsg.classList.remove('hidden');
                }
            }
            
            // 5. å¼·è¿«æé†’ (Native Alert)
            // ä½¿ç”¨ setTimeout è®“ UI å…ˆæ¸²æŸ“å‡ºä¾†å†å½ˆå‡º alertï¼Œç¢ºä¿è¦–è¦ºèˆ‡è²éŸ³éƒ½å·²å•Ÿå‹•
            setTimeout(() => {
                alert(isTest ? "æ¸¬è©¦ï¼šç°½é€€æé†’ï¼" : "æ™‚é–“åˆ°äº†ï¼è«‹è¨˜å¾—ç°½é€€ï¼");
            }, 300);

            // å˜—è©¦è‡ªå‹•èšç„¦è¦–çª—
            window.focus();
        }

        function stopAlarm() {
            alarmModal.classList.add('hidden');
            stopTitleFlash();
        }

        function updateClock() {
            const now = new Date();
            
            // æ ¼å¼åŒ–æ™‚é–“ HH:MM:SS
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const currentTimeStr = `${hours}:${minutes}`; 
            
            clockElement.innerText = `${hours}:${minutes}:${seconds}`;

            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            dateElement.innerText = now.toLocaleDateString('zh-TW', options);

            const targetTime = targetTimeInput.value;
            
            // è§¸ç™¼æ¢ä»¶ï¼šæ™‚é–“å»åˆ + ç§’æ•¸ç‚º00 + ä»Šå¤©é‚„æ²’è§¸ç™¼é
            if (currentTimeStr === targetTime && seconds === '00' && !alarmTriggeredToday) {
                // æª¢æŸ¥å·¥ä½œæ—¥ (0æ˜¯é€±æ—¥, 6æ˜¯é€±å…­)
                const day = now.getDay();
                if (day !== 0 && day !== 6) { 
                    showAlarm();
                    alarmTriggeredToday = true;
                    statusMsg.innerHTML = '<i class="fas fa-check-circle text-green-500"></i> <span class="text-green-600">ä»Šæ—¥æé†’å·²ç™¼é€</span>';
                }
            }

            // é‡ç½®èˆ‡ç‹€æ…‹é¡¯ç¤º
            if (currentTimeStr !== targetTime) {
                alarmTriggeredToday = false;
                
                const targetParts = targetTime.split(':');
                if (targetParts.length === 2) {
                    const targetDate = new Date();
                    targetDate.setHours(parseInt(targetParts[0]), parseInt(targetParts[1]), 0);
                    
                    if (now < targetDate) {
                        statusMsg.innerHTML = `<i class="fas fa-hourglass-half text-blue-500"></i> <span>ç­‰å¾… ${targetTime} æé†’ä¸­...</span>`;
                    } else {
                        statusMsg.innerHTML = `<i class="fas fa-moon text-gray-400"></i> <span>ä»Šæ—¥æé†’æ™‚é–“å·²é</span>`;
                    }
                }
            }
        }

        // æ¯ç§’æ›´æ–°
        setInterval(updateClock, 1000);
        updateClock(); 

    </script>
</body>
</html>