import React, { useState, useEffect, useRef } from 'react';
import { Copy, RefreshCw, Settings, Type, Palette, Layout, CheckCircle, Plus, Trash2, AlertCircle, Scissors, Image as ImageIcon, Download, Upload, Eraser, Droplet, Layers, FileText, Hash, X, Archive } from 'lucide-react';

// --- Prompt ç”Ÿæˆå™¨çµ„ä»¶ ---
const PromptGenerator = ({ onSwitchToSplitter }) => {
  const [textList, setTextList] = useState("æ—©å®‰ã€æ™šå®‰ã€è¬è¬ã€ä¸å®¢æ°£ã€å°ä¸èµ·ã€æ²’å•é¡Œã€å¥½çš„ã€æ”¶åˆ°ã€æ‹œè¨—ã€è¾›è‹¦äº†ã€OKã€ç­‰ç­‰");
  const [artStyle, setArtStyle] = useState("å¤§çœ¼ã€è³½ç’ç’ä¸Šè‰²");
  const [layoutType, setLayoutType] = useState("4 Ã— 3");
  const [stickerCount, setStickerCount] = useState(12);
  const [bgColor, setBgColor] = useState("#00FF00");
  const [showCopyFeedback, setShowCopyFeedback] = useState(false);
  const [limitWarning, setLimitWarning] = useState("");
  const [selectedCategory, setSelectedCategory] = useState("æ—¥å¸¸å¯¦ç”¨");

  // é è¨­é¢¨æ ¼æ¸…å–®
  const stylePresets = [
    { name: "é è¨­ (è³½ç’ç’)", value: "å¤§çœ¼ã€è³½ç’ç’ä¸Šè‰²" },
    { name: "3D ç›²ç›’", value: "3D render, C4D, blind box toy style, cute, chibi" },
    { name: "æ°´å½©æ‰‹ç¹ª", value: "soft watercolor, hand drawn, cute illustration" },
    { name: "åƒç´ è—è¡“", value: "pixel art, 8-bit, retro game style" },
    { name: "è Ÿç­†å¡—é´‰", value: "crayon drawing, scribble, children's book style" },
    { name: "çŒç±ƒé«˜æ‰‹", value: "Slam Dunk style, Takehiko Inoue, 90s anime, detailed line work, intense expression, sports manga style" }
  ];

  // æ“´å……è©å½™åº«
  const vocabularyDatabase = {
    "æ—¥å¸¸å¯¦ç”¨": [
      "æ—©å®‰", "æ™šå®‰", "åˆå®‰", "è¬è¬", "ä¸å®¢æ°£", "å°ä¸èµ·", "æ²’å•é¡Œ", "å¥½çš„", "æ”¶åˆ°", "æ‹œè¨—", 
      "è¾›è‹¦äº†", "OK", "ç­‰ç­‰", "åŠ æ²¹", "æ­å–œ", "ç”Ÿæ—¥å¿«æ¨‚", "è®š", "æ£’", "å“ˆå›‰", "æ°æ°", 
      "æ˜å¤©è¦‹", "æ™šé»è¦‹", "åƒé£½æ²’", "è‚šå­é¤“", "æƒ³ç¡è¦º", "èµ·åºŠäº†", "å‡ºé–€äº†", "åˆ°å®¶äº†", "è·¯ä¸Šå°å¿ƒ", "æ­¡è¿", 
      "äº†è§£", "æ²’é—œä¿‚", "åˆ¥å®¢æ°£", "éº»ç…©äº†", "è«‹å¤šæŒ‡æ•™", "æœå“©", "æ‹è¬", "æ„Ÿæ©", "3Q", "Good", 
      "Hi", "Hello", "Bye", "Night", "Morning", "Yes", "No", "ç‚ºä»€éº¼", "çœŸçš„å—", "æ²’äº‹",
      "å¥½å–”", "å¥½å•Š", "å¯ä»¥", "ä¸è¡Œ", "çŸ¥é“äº†", "ç¬‘æ­»", "å•è™Ÿ", "åŠ ä¸€", "è·¯é", "ç°½åˆ°"
    ],
    "æœ‰ç¦®è²Œ": [
      "è«‹å•", "éº»ç…©äº†", "ä¸å¥½æ„æ€", "è¬è¬æ‚¨", "è¾›è‹¦äº†", "å‹é§•", "è«‹å¤šæŒ‡æ•™", "æ‹œè¨—äº†", "æ‰“æ“¾äº†", "è«‹ç¨ç­‰",
      "æ„Ÿè¬", "æœ‰å‹", "è«‹æ…¢ç”¨", "å¤±é™ªäº†", "æ‰¿è’™ç…§é¡§", "ä¸å®¢æ°£", "æ²’é—œä¿‚", "è«‹é€²", "è«‹å", "æ‚¨å¥½",
      "æ—©å®‰æ‚¨å¥½", "æ™šå®‰æ‚¨å¥½", "è«‹ç¬‘ç´", "è«‹éç›®", "è«‹è¦‹è«’", "æŠ±æ­‰", "å°ä¸èµ·", "è«‹åŸè«’", "å¥½çš„è¬è¬", "æ”¶åˆ°è¬è¬",
      "äº†è§£è¬è¬", "æ²’å•é¡Œè¬è¬", "å¥½çš„éº»ç…©äº†", "æ”¶åˆ°éº»ç…©äº†", "è«‹å”åŠ©", "è«‹ç¢ºèª", "è«‹æŸ¥æ”¶", "è«‹åƒè€ƒ", "è«‹æƒ è³œ", "è«‹æŒ‡æ­£",
      "è¬åˆ†æ„Ÿè¬", "æ„Ÿæ¿€ä¸ç›¡", "å‹ç…©æ‚¨äº†", "ä¹…ä»°å¤§å", "å¹¸æœƒå¹¸æœƒ", "è«‹å¤šå¤šåŒ…æ¶µ", "é€ æˆä¸ä¾¿", "æ•¬è«‹è¦‹è«’", "æ„Ÿè¬æ‚¨çš„", "ç¥æ‚¨é †å¿ƒ"
    ],
    "ç¯€æ…¶ç¥è³€": [
      "æ–°å¹´å¿«æ¨‚", "æ­å–œç™¼è²¡", "ç´…åŒ…æ‹¿ä¾†", "å¤§å‰å¤§åˆ©", "è–èª•å¿«æ¨‚", "ç”Ÿæ—¥å¿«æ¨‚", "ä¸­ç§‹å¿«æ¨‚", "ç«¯åˆå®‰åº·", "æ¯è¦ªç¯€å¿«æ¨‚", "çˆ¶è¦ªç¯€å¿«æ¨‚",
      "æƒ…äººç¯€å¿«æ¨‚", "è¬è–ç¯€å¿«æ¨‚", "Merry Xmas", "Happy New Year", "Happy Birthday", "æ­²æ­²å¹³å®‰", "å¹´å¹´æœ‰é¤˜", "å¿ƒæƒ³äº‹æˆ", "è¬äº‹å¦‚æ„", "æ­è³€æ–°ç¦§",
      "é–‹å·¥å¤§å‰", "å…ƒå®µå¿«æ¨‚", "å‹å‹•ç¯€å¿«æ¨‚", "é€£å‡æ„‰å¿«", "æ”¾å‡å•¦", "è·¨å¹´å¿«æ¨‚", "é™¤å¤•å¿«æ¨‚", "åˆä¸€å¿«æ¨‚", "é–‹é‹", "æ‹›è²¡",
      "ç¦", "æ˜¥", "æ»¿", "ä¹–ä¹–", "æ­è¶´", "ç•¢æ¥­å¿«æ¨‚", "é€±å¹´å¿«æ¨‚", "æ–°å©šå¿«æ¨‚", "æ—©ç”Ÿè²´å­", "ç™¾å¹´å¥½åˆ",
      "é´»åœ–å¤§å±•", "æ­¥æ­¥é«˜å‡", "ç”Ÿæ„èˆˆéš†", "è²¡æºå»£é€²", "å¹³å®‰å–œæ¨‚", "èº«é«”å¥åº·", "é—”å®¶å¹³å®‰", "ä½³ç¯€æ„‰å¿«", "Happy Holiday", "Love You"
    ],
    "è·å ´ç¤¾ç•œ": [
      "æ”¶åˆ°", "å¥½çš„", "é¦¬ä¸Šè™•ç†", "è¾›è‹¦äº†", "é–‹æœƒä¸­", "ç¢ºèªä¸­", "éº»ç…©ä½ äº†", "åŠ ç­ä¸­", "å‡†æ™‚ä¸‹ç­", "è¬è¬è€é—†", 
      "æ”¶åˆ°è¬è¬", "æ²’å•é¡Œ", "è«‹ç¤º", "å ±å‘Š", "å¯©æ ¸", "ç°½æ ¸", "ä¼‘å‡ä¸­", "å‡ºå·®ä¸­", "å¿™ç¢Œä¸­", "è«‹ç¨ç­‰", 
      "äº†è§£", "å·²è®€", "å·²å¯„å‡º", "è™•ç†ä¸­", "è¿½è¹¤ä¸­", "å°ˆæ¡ˆ", "æœƒè­°", "ç°¡å ±", "å ±åƒ¹", "å®¢æˆ¶", 
      "å» å•†", "åˆç´„", "ç™¼ç¥¨", "çµ±ç·¨", "ä¸‹ç­äº†", "æˆ‘åœ¨å¿™", "æ€¥ä»¶", "ç‰¹æ€¥", "æ„Ÿè¬å”åŠ©", "è¬äº‹æ‹œè¨—", 
      "æ‡‡è«‹ç¢ºèª", "é™„ä»¶è«‹æŸ¥æ”¶", "è«‹å•é€²åº¦", "å°šæœªå›è¦†", "æé†’ä¸€ä¸‹", "æŠ±æ­‰æ‰“æ“¾", "åˆä½œæ„‰å¿«", "è«‹éç›®", "ä¿®æ­£å¾Œå›å‚³", "è«‹æ‰¹å‡†",
      "æœ¬é€±é€²åº¦", "ä¸‹é€±å¾…è¾¦", "æˆ‘åœ¨è·¯ä¸Šäº†", "å¡è»Šä¸­", "è«‹å‡ä¸€å¤©", "ç—…å‡", "äº‹å‡", "WFH", "é ç«¯ä¸­", "æ”¯æ´ä¸­"
    ],
    "æƒ…ç·’è¡¨é”": [
      "å“ˆå“ˆ", "å“­å“­", "ç”Ÿæ°£", "é©šè¨", "å‚»çœ¼", "ç„¡è¨€", "æ„›ä½ ", "è¨å­", "å¥½ç´¯", "å´©æ½°", 
      "åš‡æ­»", "å•è™Ÿ", "é–‹å¿ƒ", "é›£é", "èˆˆå¥®", "ç·Šå¼µ", "å®³ç¾", "å°·å°¬", "æ†¤æ€’", "æ†‚é¬±", 
      "ç„¡å¥ˆ", "çµ•æœ›", "æœŸå¾…", "å¤±æœ›", "æ„Ÿå‹•", "ç¾¨æ…•", "å«‰å¦’", "ç…©èº", "æ‚ é–’", "è¼•é¬†", 
      "æ»¿è¶³", "å¹¸ç¦", "å­¤å–®", "å¯‚å¯", "é©šå–œ", "ç–‘æƒ‘", "è‚¯å®š", "å¦å®š", "æ‡·ç–‘", "ç›¸ä¿¡", 
      "é©•å‚²", "è‡ªä¿¡", "å‘å¾®", "ç—›è‹¦", "çˆ½", "çˆ›", "è®š", "æ‰¯", "ç", "æšˆ",
      "ç¿»ç™½çœ¼", "å˜†æ°£", "ç™¼æŠ–", "å†’æ±—", "è‡‰ç´…", "å¿ƒç¢", "åè¡€", "æ˜å€’", "çœ¼ç¥æ­»", "é»‘äººå•è™Ÿ"
    ],
    "æƒ…ä¾¶ç”œèœœ": [
      "æ„›ä½ ", "æƒ³ä½ ", "æŠ±æŠ±", "è¦ªè¦ª", "æ—©å®‰", "æ™šå®‰", "åœ¨å¹¹å˜›", "å¥½å–”", "å°ä¸èµ·", "åŸè«’æˆ‘", 
      "å¥½æ£’", "è¾›è‹¦äº†", "å¯¶è²", "è€å…¬", "è€å©†", "è¦ªæ„›çš„", "å“ˆå°¼", "æƒ³è¦‹ä½ ", "å¯ä»¥å—", "å¥½ä¸å¥½", 
      "å¸¶æˆ‘å»", "è²·çµ¦æˆ‘", "é¤“äº†", "ç´¯ç´¯", "ç§€ç§€", "å‘¼å‘¼", "è¹­è¹­", "è²¼è²¼", "æ‘¸æ‘¸é ­", "ä¹–ä¹–", 
      "æœ€æ„›ä½ ", "å”¯ä¸€", "æ°¸é ", "ç´„æœƒ", "çœ‹é›»å½±", "åƒå¤§é¤", "å»å“ªè£¡", "é™ªæˆ‘", "ç†æˆ‘", "ä¸ç†ä½ ", 
      "å“¼", "å£å£", "è¨å­", "ç¾ç¾è‡‰", "æ„›å¿ƒ", "ç­†èŠ¯", "å•¾å’ª", "æƒ³æŠ±ç¡", "å……é›»", "æƒ³è¦ªè¦ª",
      "ä½ åœ¨å“ª", "å¿«å›ä¾†", "ç­‰æˆ‘", "æ„›ä½ å”·", "MUA", "LOVE", "Missing You", "Sweet", "Darling", "Honey"
    ],
    "å­ä¸–èªéŒ„": [
      "ä¸æƒ³ä¸Šç­", "å¥½ç´¯", "å¿ƒå¥½ç´¯", "æ”¾éæˆ‘", "éš¨ä¾¿", "å–”æ˜¯å–”", "è½ä¸æ‡‚", "çœ¼ç¥æ­»", "æƒ³å›å®¶", "äººç”Ÿå¥½é›£", 
      "åˆ¥ç…©æˆ‘", "......", "å»¢", "çˆ›", "ç…©", "æ»¾", "é–‰å˜´", "åµæ­»", "ç„¡èŠ", "æ²’æ•‘äº†", 
      "å¯æ†", "ç¬‘æ­»", "å‘µå‘µ", "æ…¢èµ°ä¸é€", "é—œæˆ‘å±äº‹", "å¹²ä½ å±äº‹", "å»æ­»", "æƒ³é›¢è·", "æƒ³é€€ä¼‘", "éŒ¢é›£è³º", 
      "è–ªæ°´å°å·", "èººå¹³", "æ“ºçˆ›", "æˆ‘å°±çˆ›", "æ²’ç©º", "ä¸çŸ¥é“", "åˆ¥å•æˆ‘", "å¿ƒæ­»", "ç´¯æˆç‹—", "æƒ³ç¡", 
      "å£“åŠ›å±±å¤§", "æ‡·ç–‘äººç”Ÿ", "ç”Ÿç„¡å¯æˆ€", "å­ä¸–", "è² èƒ½é‡", "ä½æ°£å£“", "åˆ¥ç†æˆ‘", "é‚Šç·£äºº", "æ²’æœ‹å‹", "å­¤ç¨æ­»"
    ],
    "ç¶²è·¯è¿·å› ": [
      "æˆ‘å°±çˆ›", "æ˜¯åœ¨å“ˆå›‰", "æ­¸å‰›æ¬¸", "Duckä¸å¿…", "ç¬‘æ­»", "æˆ‘å°±å•", "å¯æ†å“ª", "çœŸçš„å‡çš„", "å‚‘å‡ºçš„ä¸€æ‰‹", "ä¸è¦çæ°å¥½å—", 
      "æˆ‘å°±éœéœçœ‹è‘—ä½ ", "ç”šè‡³é‚„æœ‰", "æ˜¯åœ¨å“­", "åƒæ¥µäº†æ„›æƒ…", "å°ä¸‘ç«Ÿæ˜¯æˆ‘è‡ªå·±", "é˜¿å§¨æˆ‘ä¸æƒ³åŠªåŠ›äº†", "å¹´è¼•äººä¸è¬›æ­¦å¾·", "è€—å­å°¾æ±", "æˆ‘çœ‹ä¸æ‡‚", "ä½†æˆ‘å¤§å—éœ‡æ’¼", 
      "é—œæ–¼æˆ‘...", "æ³¨æ„çœ‹é€™å€‹ç”·äºº", "ä¸å¯ä»¥è‰²è‰²", "ä¿®ä½†å¹¾å‹’", "å’©å™—", "ç”˜å®‰æ", "æ˜¯åœ¨hello", "ç¢ºèªéçœ¼ç¥", "ä¹Ÿæ˜¯é†‰äº†", "å²å®³äº†", 
      "é€™å€‹æˆ‘ä¸è¦", "å…ˆä¸è¦", "è¦ç¢ºå®šæ¬¸", "çªç ´ç›²è…¸", "æ±‚å¿ƒç†é™°å½±é¢ç©", "æ˜¯åœ¨å“ˆå›‰?", "æœ¬æ–¥ä½†å¤§", "çœŸé¦™", "æˆ‘è¦ºå¾—å¯ä»¥", "æˆ‘è¦ºå¾—ä¸è¡Œ",
      "é€™æ³¢ä¸è™§", "å¯ä»¥", "é€™å¾ˆå¯ä»¥", "777", "87åˆ†ä¸èƒ½å†é«˜", "ä½ å„ä½", "æ˜¯åœ¨åšå¤¢å—", "é†’é†’å§", "åˆ¥åšå¤¢äº†", "ä¸‹å»"
    ],
    "å°èªé¢¨æ ¼": [
      "ç”˜å®‰æ", "æ¯æ¹¯", "æ˜¯åœ¨å“­", "æ°´å•¦", "å¥½åº·", "ç„¡èŠ", "å·´è±†å¤­", "è‚–æ¬¸", "çœŸæ­£å¥½", "å¤šè¬", 
      "æ‹è¬", "é‡‘åƒ¹æ¯æ¹¯", "å“©æ´—å‹’", "é è…°", "ä¸‰å°", "è¡ä¸‰å°", "ç¾é€", "é‡‘ç¾é€", "å®‰æŠ“", "ä¾›è¦ç±³", 
      "éº¥å®‰æ", "æ¯æ¹¯å–”", "è³€å•¦", "åšå•¦", "è³€", "æŸ", "ç„¡", "å¥½åŠ åœ¨", "é‚£æ¬¸å®‰æ", "å“©ä¾†", 
      "ä¾†ä¾†ä¾†", "ç·Šæ¬¸", "æ…¢åå", "é›–å°", "å¥½é‡äºº", "å¤éŒ", "ç·£æŠ•", "æ°´å™¹å™¹", "æ­¹å‹¢", "å¤šè¬ä½ ", 
      "å‹åŠ›", "æ„Ÿè¬", "å…å®¢æ°£", "å…", "éº¥", "è¦", "æ„›", "é’èœ", "éš¨ä¾¿", "æ­¡å–œ"
    ],
    "è³¼ç‰©/åœ˜è³¼": [
      "+1", "å·²åŒ¯æ¬¾", "é‚„æœ‰å—", "æƒ³è²·", "å¤šå°‘éŒ¢", "å«é‹å—", "ç§è¨Š", "æ’éšŠ", "è¬è¬è€é—†", "å·²å¡«å–®", 
      "å–è²¨", "å¥½ç”¨å—", "ç¾è²¨å—", "è¦ç­‰å—", "é‹è²»", "é¢äº¤", "è¶…å–", "å®…é…", "è²¨åˆ°ä»˜æ¬¾", "åˆ·å¡", 
      "è½‰å¸³", "å¾Œäº”ç¢¼", "å·²æŸ¥æ”¶", "å·²å¯„å‡º", "å¥½è³£+", "è³£è²¨ä¾¿", "è¦çš®", "é€£çµ", "é€™è£¡è²·", "é–‹åœ˜", 
      "çµå–®", "æ»¿å–®", "æµåœ˜", "é€™æ¬¾", "é¡è‰²", "å°ºå¯¸", "è¿½åŠ ", "é è³¼", "ç¾è²¨", "æ­£éŸ“", 
      "æ­£å“", "åœ˜è³¼åƒ¹", "å„ªæƒ ", "æŠ˜æ‰£", "å…é‹", "æ‰‹åˆ€", "ä¸‹å–®", "è²·è²·è²·", "è·åŒ…å¤±è¡€", "åƒåœŸ"
    ]
  };

  const generatePrompt = () => {
    return `âœ… ${stickerCount} æ ¼è§’è‰²è²¼åœ–é›†ï½œPrompt å»ºè­°
è«‹åƒè€ƒä¸Šå‚³åœ–ç‰‡ä¸­çš„è§’è‰²ï¼Œç”Ÿæˆ ä¸€å¼µåŒ…å« ${stickerCount} å€‹ä¸åŒå‹•ä½œçš„è§’è‰²è²¼åœ–é›†ï¼Œä¹Ÿä¸è¦ä½¿ç”¨ä»»ä½•emojiè¡¨æƒ…ç¬¦è™Ÿã€‚

[è§’è‰²èˆ‡é¢¨æ ¼è¨­å®š]
è§’è‰²ä¸€è‡´æ€§ï¼šå¿…é ˆå®Œå…¨ç¶­æŒåŸåœ–ä¸»è§’çš„é«®å‹ã€æœè£ã€äº”å®˜èˆ‡æ•´é«”å¤–è§€ç‰¹å¾µã€‚
æ§‹åœ–é¢¨æ ¼ï¼šç•«é¢åƒ…åŒ…å«ã€Œè§’è‰² + æ–‡å­—ã€ï¼Œä¸åŒ…å«ä»»ä½•å ´æ™¯èƒŒæ™¯ã€‚
ç•«é¢¨è¨­å®šï¼šã€${artStyle}ã€‘ã€‚
è²¼ç´™é¢¨æ ¼ï¼ˆå»èƒŒå‹å–„ï¼‰ï¼šè§’è‰²èˆ‡æ–‡å­—å¤–åœçš†éœ€åŠ å…¥ ç²—ç™½è‰²å¤–æ¡†ï¼ˆSticker Styleï¼‰ã€‚èƒŒæ™¯çµ±ä¸€ç‚º ${bgColor}ï¼ˆç´”ç¶ è‰²ï¼‰ï¼Œä¸å¯æœ‰é›œé»ã€‚

[ç•«é¢ä½ˆå±€èˆ‡å°ºå¯¸è¦æ ¼]
æ•´é«”ç‚º ${layoutType} ä½ˆå±€ï¼Œå…± ${stickerCount} å¼µè²¼åœ–ã€‚ç¸½å°ºå¯¸ï¼š1480 Ã— 960 pxã€‚
æ¯å¼µå°åœ–ç´„ 370 Ã— 320 pxï¼ˆè‡ªå‹•ç­‰æ¯”ç¸®æ”¾å¡«æ»¿æ’åˆ—ï¼‰ã€‚æ¯å¼µè²¼åœ–å››å‘¨é ç•™ç´„ 0.2 cm Paddingï¼Œé¿å…ç•«é¢äº’ç›¸é»ä½ã€‚
é¡é ­å¤šæ¨£åŒ–ï¼šå…¨èº« + åŠèº«æ··åˆï¼Œå¿…é ˆåŒ…å«æ­£é¢ã€å´é¢ã€ä¿¯è§’ç­‰ä¸åŒè¦–è§’ã€‚

[æ–‡å­—è¨­è¨ˆ]
èªè¨€ï¼šã€å°ç£ç¹é«”ä¸­æ–‡ã€‘
æ–‡å­—å…§å®¹ï¼šã€${textList}ã€‘
å­—å‹é¢¨æ ¼ï¼šã€å¯æ„› Q ç‰ˆå­—å‹ï¼Œé¡è‰²é®®è±”ã€æ˜“è®€ï¼Œå¤šè‰²å½©æ··åˆï¼Œçµ•å°ç¦æ­¢ä½¿ç”¨ä»»ä½•ç¶ è‰²ï¼ˆåŒ…å«æ·±ç¶ ã€æ·ºç¶ ã€è¢å…‰ç¶ ã€è—ç¶ ï¼‰èˆ‡é»‘è‰²ï¼Œå› ç‚ºæœƒå°è‡´å»èƒŒéŒ¯èª¤ã€‚è«‹æ”¹ç”¨ç´…ã€è—ã€ç´«ã€æ©˜ã€é»ƒç­‰é«˜å°æ¯”è‰²å½©ã€‚ã€‘
æ’ç‰ˆï¼šæ–‡å­—å¤§å°ç´„ä½”å–®å¼µè²¼åœ– 1/3ï¼Œæ–‡å­—å¯é©åº¦å£“åœ¨è¡£æœé‚Šè§’ç­‰éé‡è¦å€åŸŸï¼Œä¸èƒ½é®è‡‰,ä¹Ÿä¸è¦ä½¿ç”¨ä»»ä½•emojiè¡¨æƒ…ç¬¦è™Ÿã€‚

[è¡¨æƒ…èˆ‡å‹•ä½œè¨­è¨ˆ]
è¡¨æƒ…å¿…é ˆæ˜é¡¯ã€èª‡å¼µã€æƒ…ç·’è±å¯Œï¼šã€å–œã€æ€’ã€å“€ã€æ¨‚ã€é©šè¨ã€ç„¡èªã€æ”¾ç©ºã€å¤§å“­ã€‘
è§’è‰²å‹•ä½œéœ€èˆ‡æ–‡å­—æƒ…å¢ƒä¸€è‡´ï¼šä¾‹å¦‚ã€è¬è¬é…é›™æ‰‹åˆåã€OKæ¯”æ‰‹å‹¢ã€æ—©å®‰æ®æ‰‹ã€ç™¼å‘†æµå£æ°´ã€‘
${stickerCount} æ ¼çš†é ˆç‚º ä¸åŒå‹•ä½œèˆ‡ä¸åŒè¡¨æƒ…ã€‚

[è¼¸å‡ºæ ¼å¼]
ä¸€å¼µå¤§åœ–ï¼Œå…§å« ${layoutType} çš„ ${stickerCount} å¼µè²¼åœ–ã€‚èƒŒæ™¯å¿…é ˆç‚º ç´”ç¶ è‰² ${bgColor}ã€‚æ¯æ ¼è§’è‰² + æ–‡å­—å‡é™„ä¸Šç²—ç™½é‚Šã€‚`;
  };

  const fullPrompt = generatePrompt();

  const handleAddWord = (word) => {
    let currentList = textList === "" ? [] : textList.split("ã€").map(s => s.trim()).filter(s => s !== "");
    if (currentList.includes(word)) {
      const newList = currentList.filter(item => item !== word);
      setTextList(newList.join("ã€"));
      setLimitWarning("");
      return;
    }
    if (currentList.length >= stickerCount) {
      setLimitWarning(`âš ï¸ åªèƒ½é¸æ“‡ ${stickerCount} å€‹è©å½™ (é…åˆè²¼åœ–æ ¼æ•¸)`);
      setTimeout(() => setLimitWarning(""), 3000);
      return;
    }
    const newList = [...currentList, word];
    setTextList(newList.join("ã€"));
    setLimitWarning("");
  };

  const handleClearText = () => {
    setTextList("");
    setLimitWarning("");
  };

  const handleCopy = () => {
    const textArea = document.createElement("textarea");
    textArea.value = fullPrompt;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      setShowCopyFeedback(true);
      setTimeout(() => setShowCopyFeedback(false), 2000);
    } catch (err) {
      console.error('è¤‡è£½å¤±æ•—', err);
    }
    document.body.removeChild(textArea);
  };

  const handleReset = () => {
    setTextList("æ—©å®‰ã€æ™šå®‰ã€è¬è¬ã€ä¸å®¢æ°£ã€å°ä¸èµ·ã€æ²’å•é¡Œã€å¥½çš„ã€æ”¶åˆ°ã€æ‹œè¨—ã€è¾›è‹¦äº†ã€OKã€ç­‰ç­‰");
    setArtStyle("å¤§çœ¼ã€è³½ç’ç’ä¸Šè‰²");
    setLayoutType("4 Ã— 3");
    setStickerCount(12);
    setBgColor("#00FF00");
    setSelectedCategory("æ—¥å¸¸å¯¦ç”¨");
    setLimitWarning("");
  };

  const currentCount = textList === "" ? 0 : textList.split("ã€").filter(s => s.trim() !== "").length;
  // è§£æç›®å‰çš„è©å½™é™£åˆ—ï¼Œç”¨æ–¼é¡¯ç¤ºæ¨™ç±¤
  const currentWords = textList === "" ? [] : textList.split("ã€").map(s => s.trim()).filter(s => s !== "");

  return (
    <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">
      {/* å·¦å´ï¼šè¨­å®šé¢æ¿ (2 columns) */}
      <div className="lg:col-span-2 space-y-6">
        {/* æ–‡å­—è¨­å®š */}
        <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800">
          <div className="flex items-center gap-2 mb-4 text-[#00B900]">
            <Type size={24} />
            <h2 className="font-bold text-lg text-slate-100">1. æ–‡å­—å…§å®¹</h2>
          </div>
          
          <div className="flex justify-between items-center mb-2">
            <label className="block text-sm font-medium text-slate-400">
              åˆ†é¡é¸æ“‡ ({selectedCategory})
            </label>
            <button 
              onClick={handleClearText}
              className="flex items-center gap-1 text-xs text-red-400 hover:text-red-300 transition-colors"
            >
              <Trash2 size={12} /> æ¸…ç©ºè¼¸å…¥æ¡†
            </button>
          </div>

          <select
            value={selectedCategory}
            onChange={(e) => setSelectedCategory(e.target.value)}
            className="w-full p-2.5 mb-3 border border-slate-700 rounded-lg text-slate-200 text-sm focus:ring-2 focus:ring-[#00B900] focus:border-transparent outline-none bg-slate-950 hover:bg-slate-800 transition-colors cursor-pointer"
          >
            {Object.keys(vocabularyDatabase).map((key) => (
              <option key={key} value={key}>
                {key}
              </option>
            ))}
          </select>

          <div className="mb-4">
            <p className="text-xs text-slate-500 mb-2">é»æ“ŠæŒ‰éˆ•åŠ å…¥ (ä¸Šé™ {stickerCount} å€‹)ï¼š</p>
            <div className="flex flex-wrap gap-1.5 h-40 overflow-y-auto custom-scrollbar p-1 border border-slate-800 rounded-lg bg-slate-950">
              {vocabularyDatabase[selectedCategory].map((word, index) => {
                const isSelected = currentWords.includes(word);
                return (
                  <button
                    key={index}
                    onClick={() => handleAddWord(word)}
                    disabled={!isSelected && currentCount >= stickerCount}
                    className={`text-xs px-2 py-1 rounded border transition-all ${
                      isSelected 
                        ? "bg-[#00B900] text-white border-[#00B900]" 
                        : currentCount >= stickerCount 
                          ? "bg-slate-800 text-slate-600 border-slate-800 cursor-not-allowed" 
                          : "bg-slate-800 text-slate-300 border-slate-700 hover:bg-slate-700 hover:text-[#00B900] hover:border-[#00B900]"
                    }`}
                  >
                    {word}
                  </button>
                );
              })}
            </div>
          </div>
          
          <label className="block text-sm font-medium text-slate-400 mb-2">
            ç›®å‰é¸ä¸­çš„è©å½™ (é»æ“Šæ¨™ç±¤å¯ç§»é™¤)ï¼š
          </label>
          
          {/* æ–°å¢ï¼šå·²é¸è©å½™æ¨™ç±¤å€ (Removable Tags) */}
          <div className="flex flex-wrap gap-2 mb-3 p-3 bg-slate-950 rounded-lg border border-slate-700 min-h-[3rem]">
            {currentWords.length === 0 ? (
               <span className="text-slate-600 text-sm flex items-center h-6">å°šæœªé¸æ“‡ä»»ä½•è©å½™...</span>
            ) : (
               currentWords.map((word, index) => (
                  <button
                    key={index}
                    onClick={() => handleAddWord(word)} // handleAddWord æœƒè™•ç†ç§»é™¤é‚è¼¯
                    className="flex items-center gap-1.5 px-3 py-1 bg-blue-500/10 text-blue-300 border border-blue-500/20 rounded-full text-xs hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/20 transition-all group"
                  >
                    {word}
                    <X size={12} className="opacity-50 group-hover:opacity-100" /> 
                  </button>
               ))
            )}
          </div>

          <p className="text-xs text-slate-500 mb-1">æˆ–æ˜¯æ‰‹å‹•ç·¨è¼¯å­—ä¸²ï¼š</p>
          <textarea 
            value={textList}
            onChange={(e) => setTextList(e.target.value)}
            className="w-full h-16 p-3 border border-slate-700 rounded-lg focus:ring-2 focus:ring-[#00B900] focus:border-transparent outline-none transition-all resize-none text-slate-400 mb-1 text-sm bg-slate-950 placeholder-slate-700 font-mono"
            placeholder="é»æ“Šä¸Šæ–¹æŒ‰éˆ•åŠ å…¥ï¼Œæˆ–ç›´æ¥åœ¨æ­¤è¼¸å…¥..."
          />

          <div className="flex justify-between items-center h-6">
            <span className={`text-xs flex items-center gap-1 ${limitWarning ? "text-red-400 font-bold animate-pulse" : "text-transparent"}`}>
                <AlertCircle size={12} />
                {limitWarning}
            </span>
            <span className={`text-xs font-mono font-medium ${currentCount >= stickerCount ? "text-red-400" : "text-slate-500"}`}>
                {currentCount} / {stickerCount} è©
            </span>
          </div>
        </div>

        {/* é¢¨æ ¼è¨­å®š */}
        <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800">
          <div className="flex items-center gap-2 mb-4 text-purple-400">
            <Palette size={24} />
            <h2 className="font-bold text-lg text-slate-100">2. ç•«é¢¨è¨­å®š</h2>
          </div>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2">
                è—è¡“é¢¨æ ¼
              </label>
              <input 
                type="text" 
                value={artStyle}
                onChange={(e) => setArtStyle(e.target.value)}
                className="w-full p-3 border border-slate-700 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none mb-2 bg-slate-950 text-slate-200 placeholder-slate-600"
              />
              <div className="flex flex-wrap gap-2">
                {stylePresets.map((style) => (
                  <button
                    key={style.name}
                    onClick={() => setArtStyle(style.value)}
                    className="text-xs px-3 py-1.5 rounded-full bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 hover:text-purple-400 transition-colors"
                  >
                    {style.name}
                  </button>
                ))}
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2">
                å»èƒŒèƒŒæ™¯è‰² (Hex Code)
              </label>
              <div className="flex items-center gap-2">
                <input 
                  type="color" 
                  value={bgColor}
                  onChange={(e) => setBgColor(e.target.value)}
                  className="h-10 w-10 p-1 rounded cursor-pointer border border-slate-700 bg-slate-800"
                />
                <input 
                  type="text" 
                  value={bgColor}
                  onChange={(e) => setBgColor(e.target.value)}
                  className="flex-1 p-2 border border-slate-700 rounded-lg uppercase font-mono text-sm bg-slate-950 text-slate-200"
                />
              </div>
            </div>
          </div>
        </div>

        {/* ä½ˆå±€è¨­å®š */}
        <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800">
          <div className="flex items-center gap-2 mb-4 text-blue-400">
            <Layout size={24} />
            <h2 className="font-bold text-lg text-slate-100">3. ä½ˆå±€èˆ‡æ•¸é‡</h2>
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2">
                æ ¼æ•¸
              </label>
              <select 
                value={stickerCount}
                onChange={(e) => setStickerCount(parseInt(e.target.value))}
                className="w-full p-2 border border-slate-700 rounded-lg bg-slate-950 text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
              >
                <option value={4}>4 å¼µ</option>
                <option value={8}>8 å¼µ</option>
                <option value={12}>12 å¼µ</option>
                <option value={16}>16 å¼µ</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-400 mb-2">
                æ’åˆ—æ–¹å¼
              </label>
              <input 
                type="text" 
                value={layoutType}
                onChange={(e) => setLayoutType(e.target.value)}
                className="w-full p-2 border border-slate-700 rounded-lg bg-slate-950 text-slate-200 placeholder-slate-600 focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="ä¾‹å¦‚: 4 x 3"
              />
            </div>
          </div>
        </div>
        
        {/* å¼•å°åˆ°åˆ†å‰²ç¨‹å¼ */}
        <div 
            onClick={onSwitchToSplitter}
            className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-xl shadow-lg flex items-center justify-between cursor-pointer hover:from-blue-500 hover:to-blue-600 transition-all border border-blue-500/30"
        >
            <div className="flex items-center gap-3">
                <div className="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                    <Scissors size={20} />
                </div>
                <div>
                    <h3 className="font-bold">ä¸‹ä¸€æ­¥ï¼šåˆ†å‰²åœ–ç‰‡</h3>
                    <p className="text-xs text-blue-100">ç”Ÿæˆå®Œåœ–ç‰‡äº†å—ï¼Ÿé»æ­¤åˆ‡åœ–</p>
                </div>
            </div>
            <div className="bg-white/10 p-2 rounded-full backdrop-blur-sm">â†’</div>
        </div>

      </div>

      {/* å³å´ï¼šç”Ÿæˆçµæœ */}
      <div className="lg:col-span-3 flex flex-col h-full">
        <div className="bg-slate-900 rounded-2xl shadow-xl overflow-hidden flex flex-col h-full border border-slate-800">
          <div className="bg-slate-800/50 p-4 flex justify-between items-center border-b border-slate-800">
            <div className="flex items-center gap-2">
              <span className="w-3 h-3 rounded-full bg-red-500 shadow-sm"></span>
              <span className="w-3 h-3 rounded-full bg-yellow-500 shadow-sm"></span>
              <span className="w-3 h-3 rounded-full bg-green-500 shadow-sm"></span>
              <span className="ml-3 text-slate-400 text-sm font-mono">Generated_Prompt.txt</span>
            </div>
            <button 
              onClick={handleCopy}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 shadow-md ${
                showCopyFeedback 
                  ? "bg-green-600 text-white" 
                  : "bg-[#00B900] text-white hover:bg-[#009900]"
              }`}
            >
              {showCopyFeedback ? (
                <>
                  <CheckCircle size={18} /> å·²è¤‡è£½ï¼
                </>
              ) : (
                <>
                  <Copy size={18} /> è¤‡è£½ Prompt
                </>
              )}
            </button>
          </div>
          <div className="bg-slate-800/30 p-2 flex justify-between items-center border-b border-slate-800">
             <div className="flex items-center gap-2 px-2">
                <button 
                    onClick={handleReset}
                    className="flex items-center gap-1 text-xs text-slate-500 hover:text-slate-300 transition-colors"
                >
                    <RefreshCw size={12} /> é‡ç½®è¨­å®š
                </button>
             </div>
          </div>

          <div className="flex-1 p-6 overflow-auto custom-scrollbar bg-[#0f172a]">
            <pre className="font-mono text-slate-300 text-sm whitespace-pre-wrap leading-relaxed">
              {fullPrompt}
            </pre>
          </div>
          
          <div className="bg-slate-800 p-3 text-xs text-slate-500 text-center border-t border-slate-700">
            æç¤ºï¼šå°‡æ­¤å…§å®¹è¤‡è£½ä¸¦è²¼ä¸Šè‡³ AI ç¹ªåœ–å·¥å…·ï¼Œå»ºè­°æ­é…ã€Œåƒè€ƒåœ– (Image Prompt)ã€ä¸€åŒä½¿ç”¨ã€‚
          </div>
        </div>
      </div>
    </div>
  );
};

// --- åœ–ç‰‡åˆ†å‰²å™¨çµ„ä»¶ ---
const ImageSplitter = () => {
  const [sourceImage, setSourceImage] = useState(null);
  const [rows, setRows] = useState(3);
  const [cols, setCols] = useState(4);
  const [splitImages, setSplitImages] = useState([]);
  
  // å»èƒŒç‹€æ…‹ (é è¨­é–‹å•Ÿ)
  const [removeBg, setRemoveBg] = useState(true);
  const [targetColor, setTargetColor] = useState("#00FF00"); // é è¨­å»é™¤ç¶ è‰²
  const [threshold, setThreshold] = useState(60); // ç›¸ä¼¼åº¦é–¾å€¼ (Similarity)
  const [smoothness, setSmoothness] = useState(10); // é‚Šç·£æŸ”åŒ– (Smoothness)
  
  // æª”åè¨­å®š
  const [filenamePrefix, setFilenamePrefix] = useState("sticker");
  const [startNumber, setStartNumber] = useState(1);

  const [isProcessing, setIsProcessing] = useState(false);
  const [isZipLoaded, setIsZipLoaded] = useState(false); // æ–°å¢ç‹€æ…‹ï¼šæª¢æŸ¥ ZIP å¥—ä»¶æ˜¯å¦è¼‰å…¥

  const canvasRef = useRef(null);

  // å‹•æ…‹è¼‰å…¥ JSZip CDN
  useEffect(() => {
    if (window.JSZip) {
      setIsZipLoaded(true);
      return;
    }
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
    script.async = true;
    script.onload = () => setIsZipLoaded(true);
    document.body.appendChild(script);
    return () => {
      // Cleanup if needed, though usually we want to keep the library loaded
    };
  }, []);

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setSourceImage(event.target.result);
      };
      reader.readAsDataURL(file);
    }
  };

  useEffect(() => {
    if (sourceImage && canvasRef.current) {
      processSplit();
    }
  }, [sourceImage, rows, cols, removeBg, targetColor, threshold, smoothness, filenamePrefix, startNumber]);

  // HEX è½‰ RGB
  const hexToRgb = (hex) => {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : { r: 0, g: 255, b: 0 };
  };

  const processSplit = () => {
    setIsProcessing(true);
    // ä½¿ç”¨ requestAnimationFrame é¿å… UI å¡é “
    requestAnimationFrame(() => {
      const img = new Image();
      img.src = sourceImage;
      img.onload = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const itemWidth = img.width / cols;
        const itemHeight = img.height / rows;
        
        const newImages = [];
        const targetRGB = hexToRgb(targetColor);

        // æš«æ™‚å°‡ canvas è¨­ç‚ºå–®å€‹è²¼åœ–çš„å¤§å°
        canvas.width = itemWidth;
        canvas.height = itemHeight;

        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, itemWidth, itemHeight);
            // ç¹ªè£½éƒ¨åˆ†åœ–åƒ
            ctx.drawImage(
              img, 
              c * itemWidth, r * itemHeight, itemWidth, itemHeight, 
              0, 0, itemWidth, itemHeight
            );
            
            // å¦‚æœé–‹å•Ÿå»èƒŒ
            if (removeBg) {
               const imageData = ctx.getImageData(0, 0, itemWidth, itemHeight);
               const data = imageData.data;
               const len = data.length;
               
               // æ­å¹¾é‡Œå¾—è·é›¢æœ€å¤§å€¼ sqrt(255^2 * 3) ç´„ç‚º 441.67
               // æˆ‘å€‘å°‡ threshold æ˜ å°„åˆ° 0-441
               const distThreshold = (threshold / 100) * 200; // ç¨å¾®èª¿æ•´æ¯”ä¾‹è®“æ“ä½œæ›´ç·šæ€§
               const distSmooth = (smoothness / 100) * 100;

               for (let i = 0; i < len; i += 4) {
                 const rVal = data[i];
                 const gVal = data[i + 1];
                 const bVal = data[i + 2];
                 
                 // è¨ˆç®—èˆ‡ç›®æ¨™é¡è‰²çš„è·é›¢
                 const dist = Math.sqrt(
                   Math.pow(rVal - targetRGB.r, 2) +
                   Math.pow(gVal - targetRGB.g, 2) +
                   Math.pow(bVal - targetRGB.b, 2)
                 );
                 
                 if (dist < distThreshold) {
                    // å®Œå…¨é€æ˜
                    data[i + 3] = 0;
                 } else if (dist < distThreshold + distSmooth) {
                    // é‚Šç·£æŸ”åŒ–ï¼šæ ¹æ“šè·é›¢è¨ˆç®—é€æ˜åº¦ (0 ~ 255)
                    // dist è¶Šæ¥è¿‘ thresholdï¼Œalpha è¶Šå°
                    const alpha = ((dist - distThreshold) / distSmooth) * 255;
                    data[i + 3] = Math.floor(alpha);
                 }
               }
               ctx.putImageData(imageData, 0, 0);
            }

            // è¨ˆç®—ç›®å‰æ˜¯ç¬¬å¹¾å¼µåœ– (0-based index)
            const index = r * cols + c;
            
            // æª”åé‚è¼¯ä¿®æ­£ï¼šé è¨­è£œé›¶è‡³ 2 ä½æ•¸ (01, 02...)
            const currentNum = startNumber + index;
            const numStr = String(currentNum).padStart(2, '0');
            
            // æ ¹æ“šè¨­å®šç”¢ç”Ÿæª”å
            const fileName = `${filenamePrefix}_${numStr}.png`;

            newImages.push({
              id: `sticker_${r}_${c}`,
              src: canvas.toDataURL("image/png"),
              name: fileName
            });
          }
        }
        setSplitImages(newImages);
        setIsProcessing(false);
      };
    });
  };

  // ä¸‹è¼‰å…¨éƒ¨ (é€£çºŒä¸‹è¼‰)
  const handleDownloadAll = async () => {
    if (splitImages.length === 0) return;
    
    // ç°¡å–®æç¤º
    alert("æ­£åœ¨ä¸‹è¼‰æ‰€æœ‰åœ–ç‰‡ï¼Œè«‹ç¨å€™...");
    
    try {
       // é€£çºŒä¸‹è¼‰ (ç€è¦½å™¨å¯èƒ½æœƒé˜»æ“‹ï¼Œä½†åœ¨æŸäº›ç’°å¢ƒå¯è¡Œ)
       splitImages.forEach((img, idx) => {
          setTimeout(() => {
              const link = document.createElement("a");
              link.href = img.src;
              link.download = img.name;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }, idx * 200);
       });

    } catch (e) {
        console.error("ä¸‹è¼‰å¤±æ•—", e);
    }
  };

  // æ‰“åŒ…ä¸‹è¼‰ (ZIP)
  const handleDownloadZip = async () => {
    if (splitImages.length === 0) return;

    if (!isZipLoaded || !window.JSZip) {
      alert("ZIP å£“ç¸®åŠŸèƒ½æ­£åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦...");
      return;
    }

    try {
      const zip = new window.JSZip();
      
      splitImages.forEach((img) => {
        // å»é™¤ data URL å‰ç¶´
        const base64Data = img.src.replace(/^data:image\/(png|jpg);base64,/, "");
        zip.file(img.name, base64Data, {base64: true});
      });
      
      // é¡¯ç¤ºæ‰“åŒ…ä¸­
      const content = await zip.generateAsync({type:"blob"});
      const link = document.createElement("a");
      link.href = URL.createObjectURL(content);
      link.download = `${filenamePrefix}_pack.zip`; // ä½¿ç”¨è¨­å®šçš„å‰ç¶´ä½œç‚ºæª”å
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
    } catch (e) {
      console.error("ZIP å£“ç¸®å¤±æ•—", e);
      alert("ZIP å£“ç¸®å¤±æ•—ï¼Œè«‹é‡è©¦");
    }
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
      {/* å·¦å´ï¼šè¨­å®šèˆ‡ä¸Šå‚³ */}
      <div className="lg:col-span-1 space-y-6">
        <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800">
           <div className="flex items-center gap-2 mb-4 text-blue-400">
            <Upload size={24} />
            <h2 className="font-bold text-lg text-slate-100">1. ä¸Šå‚³èˆ‡è¨­å®š</h2>
          </div>

          <div className="mb-6">
            <label className="block text-sm font-medium text-slate-400 mb-2">
              ä¸Šå‚³ AI ç”Ÿæˆçš„è²¼åœ–å¤§åœ–
            </label>
            <div className="relative border-2 border-dashed border-slate-700 rounded-lg p-8 text-center hover:bg-slate-800 transition-colors group bg-slate-950/50">
                <input 
                    type="file" 
                    accept="image/*"
                    onChange={handleImageUpload}
                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                <div className="flex flex-col items-center gap-2 text-slate-500 group-hover:text-blue-400">
                    <ImageIcon size={32} />
                    <span className="text-sm">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡è‡³æ­¤</span>
                </div>
            </div>
            <p className="text-[10px] text-slate-500 mt-2 text-center">
              å»ºè­°å°ºå¯¸ï¼š1480 Ã— 960 px (å« 12 å¼µ)
            </p>
          </div>

          <div className="grid grid-cols-2 gap-4 mb-4">
             <div>
               <label className="block text-sm font-medium text-slate-400 mb-2">ç›´è¡Œ (Cols)</label>
               <input 
                 type="number" min="1" max="10"
                 value={cols} 
                 onChange={(e) => setCols(parseInt(e.target.value) || 1)}
                 className="w-full p-2 border border-slate-700 rounded-lg bg-slate-950 text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
               />
             </div>
             <div>
               <label className="block text-sm font-medium text-slate-400 mb-2">æ©«åˆ— (Rows)</label>
               <input 
                 type="number" min="1" max="10"
                 value={rows} 
                 onChange={(e) => setRows(parseInt(e.target.value) || 1)}
                 className="w-full p-2 border border-slate-700 rounded-lg bg-slate-950 text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none"
               />
             </div>
          </div>

          {/* æ–°å¢ï¼šæª”åè¨­å®šå€å¡Š */}
          <div className="pt-4 border-t border-slate-800">
             <div className="flex items-center gap-2 mb-3 text-slate-300">
                <FileText size={16} />
                <h3 className="text-sm font-bold">æª”åè¨­å®š (File Naming)</h3>
             </div>
             <div className="grid grid-cols-2 gap-4">
                 <div>
                   <label className="block text-xs font-medium text-slate-500 mb-1">æª”åå‰ç¶´</label>
                   <input 
                     type="text" 
                     value={filenamePrefix} 
                     onChange={(e) => setFilenamePrefix(e.target.value)}
                     className="w-full p-2 text-sm border border-slate-700 rounded-lg font-mono bg-slate-950 text-slate-200 placeholder-slate-600"
                     placeholder="sticker"
                   />
                 </div>
                 <div>
                   <label className="block text-xs font-medium text-slate-500 mb-1 flex items-center gap-1">
                      <Hash size={10} /> èµ·å§‹ç·¨è™Ÿ
                   </label>
                   <input 
                     type="number" min="0"
                     value={startNumber} 
                     onChange={(e) => setStartNumber(parseInt(e.target.value) || 0)}
                     className="w-full p-2 text-sm border border-slate-700 rounded-lg font-mono bg-slate-950 text-slate-200"
                   />
                 </div>
             </div>
             <p className="text-[10px] text-slate-500 mt-2">
                ç¯„ä¾‹ï¼š{filenamePrefix}_{String(startNumber).padStart(2, '0')}.png, {filenamePrefix}_{String(startNumber+1).padStart(2, '0')}.png... (è‡ªå‹•è£œé›¶)
             </p>
          </div>
        </div>
        
        {/* å»èƒŒè¨­å®šå€å¡Š - å¤§å¹…å‡ç´š */}
        <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800">
           <div className="flex items-center gap-2 mb-4 text-emerald-500">
            <Eraser size={24} />
            <h2 className="font-bold text-lg text-slate-100">3. å»èƒŒè¨­å®š (Chroma Key)</h2>
          </div>
          
          <div className="flex items-center justify-between mb-4 pb-4 border-b border-slate-800">
             <label className="text-sm font-medium text-slate-300">å•Ÿç”¨è‰²å½©å»èƒŒ</label>
             <button 
                onClick={() => setRemoveBg(!removeBg)}
                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${removeBg ? 'bg-emerald-600' : 'bg-slate-700'}`}
             >
                <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${removeBg ? 'translate-x-6' : 'translate-x-1'}`} />
             </button>
          </div>
          
          {removeBg && (
            <div className="space-y-4 animate-fadeIn">
              {/* é¡è‰²é¸æ“‡ */}
              <div>
                 <label className="text-xs font-medium text-slate-500 mb-1 flex items-center gap-1">
                    <Droplet size={12} /> å»é™¤é¡è‰² (Target Color)
                 </label>
                 <div className="flex gap-2 items-center">
                    <input 
                        type="color" 
                        value={targetColor}
                        onChange={(e) => setTargetColor(e.target.value)}
                        className="h-8 w-8 rounded cursor-pointer border border-slate-600 p-0.5 bg-slate-800"
                    />
                    <input 
                        type="text" 
                        value={targetColor}
                        onChange={(e) => setTargetColor(e.target.value)}
                        className="flex-1 text-xs p-1.5 border border-slate-700 rounded font-mono uppercase bg-slate-950 text-slate-200"
                    />
                 </div>
              </div>

              {/* ç›¸ä¼¼åº¦æ»‘æ¡¿ */}
              <div>
                <div className="flex justify-between text-xs text-slate-500 mb-1">
                  <span>ç›¸ä¼¼åº¦ (Similarity)</span>
                  <span>{threshold}%</span>
                </div>
                <input 
                  type="range" 
                  min="1" max="100" 
                  value={threshold} 
                  onChange={(e) => setThreshold(parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                />
              </div>

              {/* æŸ”åŒ–æ»‘æ¡¿ */}
              <div>
                <div className="flex justify-between text-xs text-slate-500 mb-1">
                  <span>é‚Šç·£æŸ”åŒ– (Smoothness)</span>
                  <span>{smoothness}%</span>
                </div>
                <input 
                  type="range" 
                  min="0" max="50" 
                  value={smoothness} 
                  onChange={(e) => setSmoothness(parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                />
              </div>
              
              <div className="text-[10px] text-slate-500 bg-slate-950 p-2 rounded border border-slate-800">
                 ğŸ’¡ èª¿æ•´å»ºè­°ï¼šå…ˆæ‹‰å‹•ã€Œç›¸ä¼¼åº¦ã€ç›´åˆ°èƒŒæ™¯æ¶ˆå¤±ï¼Œå†å¾®èª¿ã€ŒæŸ”åŒ–ã€è®“é‚Šç·£ä¸é‚£éº¼éŠ³åˆ©ã€‚
              </div>
            </div>
          )}
        </div>

        {sourceImage && (
             <div className="bg-slate-900 p-4 rounded-2xl shadow-xl border border-slate-800">
                <h3 className="text-sm font-bold text-slate-300 mb-2">åŸå§‹é è¦½</h3>
                <img src={sourceImage} alt="Source" className="w-full rounded-lg border border-slate-800" />
             </div>
        )}
      </div>

      {/* å³å´ï¼šåˆ†å‰²çµæœ */}
      <div className="lg:col-span-2">
         <div className="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-800 h-full flex flex-col">
            <div className="flex items-center justify-between mb-4">
                 <div className="flex items-center gap-2 text-[#00B900]">
                    <Scissors size={24} />
                    <h2 className="font-bold text-lg text-slate-100">2. åˆ†å‰²çµæœ ({splitImages.length} å¼µ)</h2>
                    {isProcessing && <span className="text-xs text-slate-500 animate-pulse">è™•ç†ä¸­...</span>}
                 </div>
                 
                 {splitImages.length > 0 && (
                   <div className="flex gap-2">
                     <button 
                        onClick={handleDownloadAll}
                        className="flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
                     >
                        <Download size={14} /> ä¸‹è¼‰å…¨éƒ¨ (æ•£åœ–)
                     </button>
                     <button 
                        onClick={handleDownloadZip}
                        className="flex items-center gap-1 px-3 py-1.5 bg-purple-600 text-white text-xs rounded-lg hover:bg-purple-700 transition-colors shadow-sm"
                     >
                        <Archive size={14} /> ä¸‹è¼‰ ZIP
                     </button>
                   </div>
                 )}
            </div>

            {splitImages.length === 0 ? (
                <div className="flex-1 flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-800 rounded-xl min-h-[300px] bg-slate-950/30">
                    <ImageIcon size={48} className="mb-2 opacity-20" />
                    <p>è«‹å…ˆä¸Šå‚³åœ–ç‰‡ä»¥é€²è¡Œåˆ†å‰²</p>
                </div>
            ) : (
                <div className="grid grid-cols-3 sm:grid-cols-4 gap-4 overflow-y-auto custom-scrollbar p-2 flex-1 max-h-[600px] bg-slate-950/30 rounded-xl">
                    {splitImages.map((img) => (
                        <div key={img.id} className="group relative bg-slate-800 rounded-lg overflow-hidden border border-slate-700 hover:shadow-lg hover:border-blue-500/50 transition-all">
                             {/* èƒŒæ™¯åœ–æ¡ˆæ”¹ç‚ºé€æ˜æ ¼ï¼Œæ–¹ä¾¿æª¢æŸ¥å»èƒŒæ•ˆæœ */}
                             <div className="w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-white/5">
                                <img src={img.src} alt={img.name} className="w-full h-auto object-contain" />
                             </div>
                             
                             <div className="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity gap-2 backdrop-blur-[2px]">
                                <a 
                                    href={img.src} 
                                    download={img.name}
                                    className="p-2 bg-white/20 rounded-full hover:bg-white/40 text-white backdrop-blur-sm transition-colors"
                                    title="ä¸‹è¼‰æ­¤å¼µ"
                                >
                                    <Download size={20} />
                                </a>
                             </div>
                             <div className="absolute bottom-0 left-0 right-0 bg-slate-900/90 text-[10px] text-center py-1 text-slate-300 truncate px-1 border-t border-slate-800">
                                {img.name}
                             </div>
                        </div>
                    ))}
                </div>
            )}
            {/* Hidden Canvas for processing */}
            <canvas ref={canvasRef} className="hidden"></canvas>
         </div>
      </div>
    </div>
  );
};

// --- ä¸»ç¨‹å¼ App ---
const App = () => {
  const [activeTab, setActiveTab] = useState("generator");

  return (
    <div className="min-h-screen bg-slate-950 text-slate-200 font-sans p-4 md:p-8">
      <div className="max-w-6xl mx-auto">
        <header className="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
          <div>
            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
              <span className="bg-[#00B900] text-white p-2 rounded-lg text-xl shadow-[0_0_15px_rgba(0,185,0,0.4)]">LINE</span>
              è²¼åœ–å·¥å…·ç®±
            </h1>
            <p className="text-slate-400 mt-2 text-sm">AI è¼”åŠ©è²¼åœ–è£½ä½œï¼šå¾ Prompt ç”Ÿæˆåˆ°åœ–ç‰‡åˆ†å‰²ä¸€ç«™å¼å®Œæˆ</p>
          </div>

          <div className="bg-slate-900 p-1 rounded-xl border border-slate-800 shadow-lg flex">
            <button
                onClick={() => setActiveTab("generator")}
                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all ${
                    activeTab === "generator" 
                    ? "bg-[#00B900] text-white shadow-md" 
                    : "text-slate-400 hover:bg-slate-800 hover:text-slate-200"
                }`}
            >
                <Type size={16} /> Prompt ç”Ÿæˆå™¨
            </button>
            <button
                onClick={() => setActiveTab("splitter")}
                className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all ${
                    activeTab === "splitter" 
                    ? "bg-blue-600 text-white shadow-md" 
                    : "text-slate-400 hover:bg-slate-800 hover:text-slate-200"
                }`}
            >
                <Scissors size={16} /> åœ–ç‰‡åˆ†å‰²å·¥å…·
            </button>
          </div>
        </header>

        {activeTab === "generator" ? (
            <PromptGenerator onSwitchToSplitter={() => setActiveTab("splitter")} />
        ) : (
            <ImageSplitter />
        )}

      </div>
    </div>
  );
};

export default App;
