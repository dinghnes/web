import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { 
  Copy, Check, LayoutGrid, Palette, Terminal, 
  Briefcase, Heart, MessageCircle, Sun, 
  Gift, Laugh, Shuffle, Type, ChevronDown,
  Smile, Hand, Star, Sticker,
  Upload, Download, RefreshCw, Scissors, Settings, 
  Layers, Droplet, Package, FileText, Hash, Sparkles, Wand2, Image as ImageIcon
} from 'lucide-react';

// ==========================================
// Part 1: Prompt Generator Component
// ==========================================
const PromptGenerator = ({ mode, setMode }) => {
  const [styleType, setStyleType] = useState("Japanese Anime");
  const [language, setLanguage] = useState("å°ç£ç¹é«”ä¸­æ–‡");
  const [copied, setCopied] = useState(false);
  
  // è²¼åœ– (Sticker) è©åº«
  const stickerCategories = {
    daily: {
      id: 'daily',
      label: 'æ—¥å¸¸ç”Ÿæ´»',
      icon: <Sun size={14} />,
      pool: [
        "æ—©å®‰", "æ™šå®‰", "åˆå®‰", "è¬è¬", "ä¸å®¢æ°£", "å°ä¸èµ·", "æ²’å•é¡Œ", "å¥½çš„", "æ”¶åˆ°", "æ‹œè¨—", 
        "è¾›è‹¦äº†", "OK", "ç­‰ç­‰", "å“ˆå›‰", "å†è¦‹", "è·¯ä¸Šå°å¿ƒ", "å¥½å¤¢", "åƒé£½æ²’", "æˆ‘ä¹Ÿè¦", "èµ°å§", 
        "æ²’é—œä¿‚", "æ­å–œ", "å¥½ä¹…ä¸è¦‹", "ç”Ÿæ—¥å¿«æ¨‚", "åŠ æ²¹", "æ²’äº‹", "çœŸçš„å—", "äº†è§£", "æŠ±æ­‰", "éº»ç…©äº†", 
        "ç¨ç­‰", "å‡ºç™¼", "å›å®¶", "ç¡è¦º", "èµ·åºŠ", "é¤“äº†", "æ¸´äº†", "å¥½åƒ", "å¥½ç©", "é–‹å¿ƒ", 
        "é›£é", "ç”Ÿæ°£", "ç´¯äº†", "ä¼‘æ¯", "å¿™ç¢Œ", "æœ‰ç©ºå—", "åœ¨å“ª", "åˆ°äº†", "å¿«åˆ°äº†", "å¡è»Š", 
        "ä¸‹é›¨", "å¥½ç†±", "å¥½å†·", "ç©¿æš–é»", "å¤šå–æ°´", "è®š", "æ£’", "ä¸éŒ¯", "å¯ä»¥", "ä¸è¡Œ", 
        "éš¨ä¾¿", "éƒ½å¥½", "çœ‹ä½ ", "ç´„å—", "å¹¾é»", "å“ªè£¡", "é€™è£¡", "é‚£è£¡", "èª°", "ä»€éº¼", 
        "ç‚ºä»€éº¼", "æ€éº¼è¾¦", "æ•‘å‘½", "å¹«å¿™", "æ”¯æ´", "æ„Ÿè¬", "æ„Ÿæ©", "è¬å•¦", "å®‰å®‰", "å—¨", 
        "æ°æ°", "æ˜å¤©è¦‹", "ä¸‹æ¬¡ç´„", "æœ‰äº‹", "æ²’äº‹å•¦", "åˆ¥æ“”å¿ƒ", "æ”¾å¿ƒ", "ä¿é‡", "ç¢ºå¯¦", "åŸä¾†å¦‚æ­¤", 
        "ç­†è¨˜", "ä¹Ÿå¯ä»¥", "æˆ–è€…æ˜¯", "ç„¶å¾Œ", "ä½†æ˜¯", "å› ç‚º", "æ‰€ä»¥", "å“ˆå“ˆ", "å˜¿å˜¿", "å—¯å—¯"
      ]
    },
    work: {
      id: 'work',
      label: 'ä¸Šç­ç¤¾ç•œ',
      icon: <Briefcase size={14} />,
      pool: [
        "æ”¶åˆ°", "è¾›è‹¦äº†", "é–‹æœƒä¸­", "è¶•å·¥ä¸­", "åŠ ç­ä¸­", "è«‹éç›®", "å ±å‘Š", "éº»ç…©äº†", "æ”¶åˆ°è¬è¬", "å‡†å¥", 
        "+1", "OK", "ç­†è¨˜", "è™•ç†ä¸­", "å·²é€å‡º", "æ±‚æ•‘", "æˆ‘åœ¨å¿™", "é¦¬ä¸Šå¥½", "ä¿®å¥½äº†", "è«‹ç¢ºèª", 
        "Approved", "è«‹æ¬¾", "å‡ºå·®ä¸­", "æ‚¨å¥½", "æ—©", "æ™šé»å›", "ç¨å¾Œ", "æœƒæœ‰æœƒè­°å—", "è«‹å•", "è¬è¬è€é—†", 
        "å¥½çš„æ²’å•é¡Œ", "äº†è§£", "æ”¶åˆ°äº†", "å·²è®€", "æ²’å•é¡Œ", "å¥½çš„", "é¦¬ä¸Šè™•ç†", "è«‹ç¤º", "è«‹æ‰¹ç¤º", "ç°½æ ¸", 
        "æ­¸æª”", "é™„ä»¶", "è½‰å¯„", "å‰¯æœ¬", "å¯†ä»¶", "æœƒè­°å®¤", "æŠ•å½±æ©Ÿ", "ç°¡å ±", "ææ¡ˆ", "é ç®—", 
        "å ±éŠ·", "ç™¼ç¥¨", "çµ±ç·¨", "è«‹å‡", "ç—…å‡", "äº‹å‡", "ç‰¹ä¼‘", "è£œä¼‘", "é²åˆ°", "æ—©é€€", 
        "æ‰“å¡", "ä¸‹ç­", "å‘¨å ±", "æœˆå ±", "å­£å ±", "å¹´å ±", "ç¸¾æ•ˆ", "KPI", "ç›®æ¨™", "é€²åº¦"
      ]
    },
    emotional: {
      id: 'emotional',
      label: 'æƒ…ç·’/å¹¹è©±',
      icon: <MessageCircle size={14} />,
      pool: [
        "ç¬‘æ­»", "ç¢ºï¼Ÿ", "ç„¡è¨€", "åš‡æ­»", "å“­å•Š", "æ°£æ­»", "å¥½å–”", "??", "!!", "æ­å–œ", 
        "åŠ æ²¹", "å‚»çœ¼", "æˆ‘å°±çˆ›", "æ˜¯åœ¨å“ˆå›‰", "çœŸçš„å‡çš„", "åˆ¥é¬§", "å£“åŠ›å±±å¤§", "æšˆå€’", "çœ¼ç¥æ­»", "ç™¼ç˜‹", 
        "å¯æ†", "ç¾¨æ…•", "å¤ªæ‰¯", "å“ˆå“ˆ", "å‘µå‘µ", "å˜¿å˜¿", "å˜»å˜»", "å—šå—š", "å”‰", "å˜–", 
        "å“¼", "å“‡", "é ", "å¹¹å˜›", "ç…©", "è¨å­", "æ»¾", "é–‰å˜´", "å®‰éœ", "åµæ­»", 
        "æ€•", "æŠ–", "é©š", "æ€’", "æ‚²", "å–œ", "æ¨‚", "çˆ½", "è®š", "çˆ›"
      ]
    },
    love: {
      id: 'love',
      label: 'æƒ…ä¾¶/æ’’å¬Œ',
      icon: <Heart size={14} />,
      pool: [
        "æƒ³ä½ ", "æ„›ä½ ", "æŠ±æŠ±", "è¦ªè¦ª", "æ™šå®‰å®‰", "é¤“äº†", "æ—©é»ç¡", "åœ¨å¹¹å˜›", "å¥½æ£’", "å“¼", 
        "æ‹œè¨—å•¦", "å°ä¸èµ·", "ç†æˆ‘", "å¥½æƒ³ä½ ", "å•¾å’ª", "æ„›å¿ƒ", "å¯ä»¥å—", "ä¸ç®¡", "æœ€æ„›ä½ ", "é¼»è¦", 
        "ç§€ç§€", "è²¼è²¼", "ç­‰ä½ å–”", "æ—©å®‰å®‰", "å¯¶è²", "è€å…¬", "è€å©†", "å“ˆå°¼", "è¦ªæ„›çš„", "ç¬¨è›‹", 
        "å‚»ç“œ", "è±¬é ­", "å£è›‹", "è¨å­é¬¼", "å°å¯æ„›", "å°å¯¶è²", "æŠ±ç·Šè™•ç†", "è¹­è¹­", "æ‘¸é ­", "ç‰½æ‰‹"
      ]
    },
    holiday: {
      id: 'holiday',
      label: 'ç¯€æ—¥æ…¶ç¥',
      icon: <Gift size={14} />,
      pool: [
        "æ–°å¹´å¿«æ¨‚", "ç”Ÿæ—¥å¿«æ¨‚", "è–èª•å¿«æ¨‚", "æ­å–œç™¼è²¡", "è¬è–ç¯€", "æƒ…äººç¯€å¿«æ¨‚", "æ¯è¦ªç¯€å¿«æ¨‚", "çˆ¶è¦ªç¯€å¿«æ¨‚", "ç«¯åˆå®‰åº·", "ä¸­ç§‹å¿«æ¨‚", 
        "è·¨å¹´å›‰", "Happy New Year", "Merry Xmas", "Happy Birthday", "æ­å–œæ­å–œ", "å¤§å‰å¤§åˆ©", "ç´…åŒ…æ‹¿ä¾†", "æ­²æ­²å¹³å®‰", "æ­¥æ­¥é«˜å‡", "å¿ƒæƒ³äº‹æˆ", 
        "ä¹¾æ¯", "æ…¶ç¥", "æ´¾å°", "å¥½é‹æ—ºæ—º", "å¹´å¹´æœ‰é¤˜", "æ‹›è²¡é€²å¯¶", "é–‹å·¥å¤§å‰", "æƒ…äººç¯€", "ä¸ƒå¤•", "å¿«æ¨‚", 
        "å¹³å®‰", "å¥åº·", "é †åˆ©", "ç™¼å¤§è²¡", "è³ºå¤§éŒ¢", "ä¸­å¤§ç", "å°¾ç‰™", "æ˜¥é…’", "åœçˆ", "åœ˜åœ“"
      ]
    },
    meme: {
      id: 'meme',
      label: 'æç¬‘è¿·å› ',
      icon: <Laugh size={14} />,
      pool: [
        "å¾å¾å®¹å®¹", "é€£æ»¾å¸¶çˆ¬", "è¶…æ´¾", "å°Šå˜Ÿå‡å˜Ÿ", "ç ´é˜²äº†", "è§¸çˆ›", "å¾ˆèº", "é€™æˆ‘", "æšˆèˆ¹", "ä¸‹èˆ¹", 
        "ç´”æ„›æˆ°å£«", "æˆ€æ„›è…¦", "Iäºº", "Eäºº", "ç¬‘çˆ›", "è¦ç¢ºæ¬¸", "æ€¥äº†", "ç´…æº«", "è²¼è‡‰é–‹å¤§", "å„ªå‹¢åœ¨æˆ‘", 
        "åŠå ´é–‹é¦™æª³", "é ‚çˆ›", "çœŸé ‚", "æœ‰æ–™", "é€™æŠŠé«˜ç«¯å±€", "èœé›", "å¤§è…¿", "å‡±ç‘", "æå¿ƒæ…‹", "å¿ƒæ…‹ç‚¸è£‚", 
        "æƒ…å‹’", "çœ¼ç¥æ­»", "èººå¹³", "æ“ºçˆ›", "å…§æ²", "ç¤¾æ­»", "Cä½", "ä¹ä¸è¶…äºº", "å‹å–„æ™‚å…‰", "ä¸»æ‰“ä¸€å€‹"
      ]
    }
  };

  // è¡¨æƒ…è²¼ (Emoji) è©åº«
  const emojiCategories = {
    faces: {
      id: 'faces',
      label: 'è¡¨æƒ…ç‰¹å¯«',
      icon: <Smile size={14} />,
      pool: [
        "å¤§ç¬‘", "å¾®ç¬‘", "çœ¨çœ¼", "é£›å»", "æ„›å¿ƒçœ¼", "æµå£æ°´", "å¤§å“­", "æµæ·š", "é©šè¨", "å°–å«",
        "ç”Ÿæ°£", "æš´æ€’", "ç„¡è¨€", "ç¿»ç™½çœ¼", "æƒ³ç¡", "æ‰“å“ˆæ¬ ", "ç”Ÿç—…", "æˆ´å£ç½©", "å˜”å", "æšˆå€’",
        "å¢¨é¡", "è£é…·", "å®³ç¾", "è‡‰ç´…", "ç–‘æƒ‘", "æ€è€ƒ", "æµæ±—", "å°·å°¬", "å´©æ½°", "çœ¼ç¥æ­»",
        "å¥¸ç¬‘", "é™°éšª", "å´‡æ‹œ", "æ˜Ÿæ˜Ÿçœ¼", "ç™¼å…‰", "å¤©ä½¿", "æƒ¡é­”", "è±¬é ­", "ç‹—é ­", "è²“è‡‰",
        "OKè¡¨æƒ…", "Noè¡¨æƒ…", "æœŸå¾…", "èˆˆå¥®", "æ»¿è¶³", "äº«å—", "ç™¼å‘†", "æ”¾ç©º", "çŸ³åŒ–", "é»‘ç·š"
      ]
    },
    hands: {
      id: 'hands',
      label: 'æ‰‹å‹¢å‹•ä½œ',
      icon: <Hand size={14} />,
      pool: [
        "æ¯”è®š", "å€’è®š", "OK", "æ„›å¿ƒ", "æ‰‹æŒ‡æ„›å¿ƒ", "å‹åˆ©YA", "æ“ŠæŒ", "åˆåæ„Ÿè¬", "æ‹œè¨—", "é¼“æŒ",
        "æ¡æ‹³åŠ æ²¹", "æŒ‡äºº", "æŒ‡ä¸Šé¢", "æŒ‡ä¸‹é¢", "æŒ‡å·¦é‚Š", "æŒ‡å³é‚Š", "æ‰“æ‹›å‘¼", "æ®æ‰‹", "æ•¬ç¦®", "æ¡æ‰‹",
        "ç¦æ­¢æ‰‹å‹¢", "å®‰éœæ‰‹å‹¢", "è‚Œè‚‰å±•ç¤º", "æ“æŠ±", "æ‘¸é ­", "æè‡‰", "æˆ³è‡‰", "é®è‡‰", "é®çœ¼", "é®è€³"
      ]
    },
    work_tags: {
      id: 'work_tags',
      label: 'å·¥ä½œ/æ´»å‹•å¯¦ç”¨',
      icon: <Briefcase size={14} />,
      pool: [
        "é–‹æœƒ", "ä¼‘å‡", "åŠ ç­", "å‡ºå·®", "å€¼ç­", "è«‹å‡", "OK", "æ”¶åˆ°", "ç¢ºèª", "å¾…è¾¦",
        "å®Œæˆ", "æ€¥ä»¶", "é‡è¦", "æé†’", "æ³¨æ„", "å…¬å‘Š", "æ´»å‹•", "èšé¤", "å ±å", "æˆªæ­¢",
        "é›†åˆ", "å‡ºç™¼", "é²åˆ°", "æ—©é€€", "ç¹³è²»", "å…è²»", "å„ªæƒ ", "æš«åœ", "å–æ¶ˆ", "å»¶æœŸ"
      ]
    },
    symbols: {
      id: 'symbols',
      label: 'è£é£¾ç¬¦è™Ÿ',
      icon: <Star size={14} />,
      pool: [
        "å¤§æ„›å¿ƒ", "ç ´ç¢æ„›å¿ƒ", "é–ƒäº®", "æ˜Ÿæ˜Ÿ", "éŸ³ç¬¦", "é©šå˜†è™Ÿ", "å•è™Ÿ", "ç¡è¦ºZzz", "ç”Ÿæ°£ç¬¦è™Ÿ", "æ±—æ»´",
        "ç«", "çˆ†ç‚¸", "ç‡ˆæ³¡", "éŒ¢è¢‹", "ä¾¿ä¾¿", "å¹½éˆ", "éª·é«", "è›‹ç³•", "ç¦®ç‰©", "èŠ±æœµ",
        "å¤ªé™½", "æœˆäº®", "ä¸‹é›¨", "é–ƒé›»", "å½©è™¹", "é‘½çŸ³", "çš‡å† ", "çç›ƒ", "ä¿¡å°", "æ‰‹æ©Ÿ"
      ]
    }
  };

  // æ ¹æ“šæ¨¡å¼åˆ‡æ›ç•¶å‰ä½¿ç”¨çš„åˆ†é¡èˆ‡è©åº«
  const currentCategories = mode === 'sticker' ? stickerCategories : emojiCategories;
  const initialCategoryKey = mode === 'sticker' ? 'daily' : 'faces';

  // ç‹€æ…‹
  const [activeCategory, setActiveCategory] = useState(initialCategoryKey);
  const [phrases, setPhrases] = useState(currentCategories[initialCategoryKey].pool.slice(0, 12));

  // ç•¶æ¨¡å¼æ”¹è®Šæ™‚ï¼Œé‡ç½®åˆ†é¡èˆ‡è©å½™
  useEffect(() => {
    const defaultCat = mode === 'sticker' ? 'daily' : 'faces';
    setActiveCategory(defaultCat);
    setPhrases(getRandomPhrases(mode === 'sticker' ? stickerCategories.daily.pool : emojiCategories.faces.pool));
  }, [mode]);

  // é¢¨æ ¼é¸é …
  const styleOptions = [
    { value: "Japanese Anime", label: "æ—¥ç³»å‹•æ¼«é¢¨ (é è¨­)", desc: "è³½ç’çä¸Šè‰²ã€ç·šæ¢æ¸…æ™°ã€å‹•æ¼«æ„Ÿ" },
    { value: "Big Eyes Cel Shading", label: "å¤§çœ¼è³½ç’ç’é¢¨", desc: "å¤§çœ¼ã€è³½ç’ç’ä¸Šè‰²" },
    { value: "2D Flat Cute", label: "2D å¹³é¢å¯æ„›", desc: "å¯æ„›ã€æ´»æ½‘ã€2Då¹³é¢" },
    { value: "Hand Drawn Watercolor", label: "æ‰‹ç¹ªæ°´å½©é¢¨", desc: "æŸ”å’Œã€æ°´å½©ç­†è§¸ã€æ‰‹ç¹ªè³ªæ„Ÿ" },
    { value: "3D Chibi Pixar", label: "3D Qç‰ˆçš®å…‹æ–¯é¢¨", desc: "3D æ¸²æŸ“ã€Qç‰ˆæ¯”ä¾‹ã€é«˜å“è³ªæè³ª" },
    { value: "American Cartoon", label: "ç¾å¼å¡é€šé¢¨", desc: "ç²—ç·šæ¢ã€èª‡å¼µè®Šå½¢ã€é®®è±”è‰²å½©" },
    { value: "Retro Pixel Art", label: "å¾©å¤åƒç´ é¢¨", desc: "8-bit, åƒç´ è—è¡“, å¾©å¤éŠæˆ²é¢¨æ ¼" },
  ];

  const getRandomPhrases = (pool) => {
    const shuffled = [...pool].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 12);
  };

  const handleCategoryChange = (catKey) => {
    setActiveCategory(catKey);
    setPhrases(getRandomPhrases(currentCategories[catKey].pool));
  };

  const handleShuffleCurrent = () => {
    const pool = currentCategories[activeCategory]?.pool || [];
    setPhrases(getRandomPhrases(pool));
  };

  // ç”¢ç”Ÿ Prompt çš„é‚è¼¯
  const generatePrompt = () => {
    const selectedStyle = styleOptions.find(s => s.value === styleType);
    const styleDesc = selectedStyle ? selectedStyle.desc : "è³½ç’çä¸Šè‰²ã€ç·šæ¢æ¸…æ™°ã€å‹•æ¼«æ„Ÿ";
    const phraseString = phrases.join('ã€');
    
    if (mode === 'sticker') {
      // --- è²¼åœ–æ¨¡å¼ (Sticker Mode) ---
      return `âœ… 12 æ ¼ LINE è²¼åœ– (Sticker)ï½œPrompt å»ºè­°
è«‹åƒè€ƒä¸Šå‚³åœ–ç‰‡ä¸­çš„è§’è‰²ï¼Œç”Ÿæˆ ä¸€å¼µåŒ…å« 12 å€‹ä¸åŒå‹•ä½œçš„è§’è‰²è²¼åœ–é›†ã€‚

[è§’è‰²èˆ‡é¢¨æ ¼è¨­å®š]
è§’è‰²ä¸€è‡´æ€§ï¼šå¿…é ˆå®Œå…¨ç¶­æŒåŸåœ–ä¸»è§’çš„é«®å‹ã€æœè£ã€äº”å®˜èˆ‡æ•´é«”å¤–è§€ç‰¹å¾µã€‚
æ§‹åœ–é¢¨æ ¼ï¼šç•«é¢åƒ…åŒ…å«ã€Œè§’è‰² + æ–‡å­—ã€ï¼Œä¸åŒ…å«ä»»ä½•å ´æ™¯èƒŒæ™¯ã€‚
ç•«é¢¨è¨­å®šï¼šã€${styleDesc}ã€‘ã€‚
è²¼ç´™é¢¨æ ¼ï¼ˆå»èƒŒå‹å–„ï¼‰ï¼šè§’è‰²èˆ‡æ–‡å­—å¤–åœçš†éœ€åŠ å…¥ ç²—ç™½è‰²å¤–æ¡†ï¼ˆSticker Styleï¼‰ã€‚èƒŒæ™¯çµ±ä¸€ç‚º #00FF00ï¼ˆç´”ç¶ è‰²ï¼‰ï¼Œä¸å¯æœ‰é›œé»ã€‚

[ç•«é¢ä½ˆå±€èˆ‡å°ºå¯¸è¦æ ¼]
æ•´é«”ç‚º 4 Ã— 3 ä½ˆå±€ï¼Œå…± 12 å¼µè²¼åœ–ã€‚ç¸½å°ºå¯¸ï¼š1480 Ã— 960 pxã€‚
æ¯å¼µå°åœ–ç´„ 370 Ã— 320 pxï¼ˆè‡ªå‹•ç­‰æ¯”ç¸®æ”¾å¡«æ»¿æ’åˆ—ï¼‰ã€‚æ¯å¼µè²¼åœ–å››å‘¨é ç•™ç´„ 0.2 cm Paddingï¼Œé¿å…ç•«é¢äº’ç›¸é»ä½ã€‚
é¡é ­å¤šæ¨£åŒ–ï¼šå…¨èº« + åŠèº«æ··åˆï¼Œå¿…é ˆåŒ…å«æ­£é¢ã€å´é¢ã€ä¿¯è§’ç­‰ä¸åŒè¦–è§’ã€‚

[æ–‡å­—è¨­è¨ˆ]
èªè¨€ï¼šã€${language}ã€‘
æ–‡å­—å…§å®¹ï¼šã€${phraseString}ã€‘
å­—å‹é¢¨æ ¼ï¼šã€å¯æ„› Q ç‰ˆå­—å‹ï¼Œé¡è‰²é®®è±”ã€æ˜“è®€ï¼Œå¤šè‰²å½©æ··åˆï¼Œçµ•å°ç¦æ­¢ä½¿ç”¨ä»»ä½•ç¶ è‰²ï¼ˆåŒ…å«æ·±ç¶ ã€æ·ºç¶ ã€è¢å…‰ç¶ ã€è—ç¶ ï¼‰èˆ‡é»‘è‰²ï¼Œå› ç‚ºæœƒå°è‡´å»èƒŒéŒ¯èª¤ã€‚è«‹æ”¹ç”¨ç´…ã€è—ã€ç´«ã€æ©˜ã€é»ƒç­‰é«˜å°æ¯”è‰²å½©ã€‚ã€‘
æ’ç‰ˆï¼šæ–‡å­—å¤§å°ç´„ä½”å–®å¼µè²¼åœ– 1/3ï¼Œæ–‡å­—å¯é©åº¦å£“åœ¨è¡£æœé‚Šè§’ç­‰éé‡è¦å€åŸŸï¼Œä¸èƒ½é®è‡‰ï¼Œä¸è¦ä½¿ç”¨emojiè¡¨æƒ…ç¬¦è™Ÿã€‚

[è¡¨æƒ…èˆ‡å‹•ä½œè¨­è¨ˆ]
è¡¨æƒ…å¿…é ˆæ˜é¡¯ã€èª‡å¼µã€æƒ…ç·’è±å¯Œï¼šã€å–œã€æ€’ã€å“€ã€æ¨‚ã€é©šè¨ã€ç„¡èªã€æ”¾ç©ºã€å¤§å“­ã€‘
è§’è‰²å‹•ä½œéœ€èˆ‡æ–‡å­—æƒ…å¢ƒä¸€è‡´ã€‚
12 æ ¼çš†é ˆç‚º ä¸åŒå‹•ä½œèˆ‡ä¸åŒè¡¨æƒ…ã€‚

[è¼¸å‡ºæ ¼å¼]
ä¸€å¼µå¤§åœ–ï¼Œå…§å« 4 Ã— 3 çš„ 12 å¼µè²¼åœ–ã€‚èƒŒæ™¯å¿…é ˆç‚º ç´”ç¶ è‰² #00FF00ã€‚æ¯æ ¼è§’è‰² + æ–‡å­—å‡é™„ä¸Šç²—ç™½é‚Šã€‚
--ar 37:24 --v 6.0`;
    } else {
      // --- è¡¨æƒ…è²¼æ¨¡å¼ (Emoji Mode) ---
      return `âœ… 12 æ ¼ LINE è¡¨æƒ…è²¼ (Emoji)ï½œPrompt å»ºè­°
è«‹åƒè€ƒä¸Šå‚³åœ–ç‰‡ä¸­çš„è§’è‰²ï¼Œç”Ÿæˆä¸€å¼µåŒ…å« 12 å€‹ LINE è¡¨æƒ…è²¼çš„åœ–é›†ã€‚

[è§’è‰²èˆ‡é¢¨æ ¼è¨­å®š]
è§’è‰²ä¸€è‡´æ€§ï¼šç¶­æŒåŸåœ–ä¸»è§’ç‰¹å¾µï¼Œä½†å°‡å…¶è½‰åŒ–ç‚ºã€Œè¡¨æƒ…è²¼ã€é¢¨æ ¼ã€‚
Emoji é¢¨æ ¼é‡é»ï¼š
1. ã€å¤§é ­ç‰¹å¯« + ä¸Šæ–¹æ–‡å­—ã€‘ï¼šæ§‹åœ–çµ±ä¸€ç‚ºã€Œè§’è‰²é ­éƒ¨åœ¨ä¸‹æ–¹ï¼Œæ–‡å­—åœ¨é ­é ‚ä¸Šæ–¹ã€ã€‚
2. ç•«é¢¨è¨­å®šï¼šã€${styleDesc}ï¼Œç·šæ¢å¿…é ˆæ›´ç°¡å–®ã€æ¸…æ™°ï¼Œé©åˆç¸®å°è§€çœ‹ã€‘ã€‚
3. å»èƒŒå‹å–„ï¼šæ¯å€‹è¡¨æƒ…(å«æ–‡å­—)å‘¨åœéœ€æœ‰ ç²—ç™½è‰²å¤–æ¡†ã€‚èƒŒæ™¯çµ±ä¸€ç‚º #00FF00ï¼ˆç´”ç¶ è‰²ï¼‰ã€‚

[ç•«é¢ä½ˆå±€]
æ•´é«”ç‚º 4 Ã— 3 ä½ˆå±€ï¼Œå…± 12 å€‹è¡¨æƒ…è²¼ã€‚
æ’åˆ—æ•´é½Šï¼Œå½¼æ­¤ä¸é‡ç–Šã€‚

[å…§å®¹èˆ‡æ–‡å­—è¨­è¨ˆ]
æ–‡å­—å…§å®¹ï¼šã€${phraseString}ã€‘
æ–‡å­—ä½ç½®ï¼šå¿…é ˆå¯«åœ¨è§’è‰²çš„ã€Œé ­é ‚ä¸Šæ–¹ã€ã€‚
æ–‡å­—é¢¨æ ¼ï¼šé»‘è‰²æˆ–æ·±è‰²ç²—é«”å­—ï¼Œæ¸…æ™°æ˜“è®€ï¼Œä¸è¦é®æ“‹åˆ°è§’è‰²è‡‰éƒ¨ã€‚
å‹•ä½œè¡¨æƒ…ï¼šè«‹æ ¹æ“šæ–‡å­—å«ç¾©ç¹ªè£½å°æ‡‰çš„è§’è‰²è¡¨æƒ…ï¼ˆä¾‹å¦‚æ–‡å­—æ˜¯ã€ŒOKã€å‰‡ç•«å‡ºOKçš„æ‰‹å‹¢æˆ–è¡¨æƒ…ï¼‰ã€‚

[è¼¸å‡ºæ ¼å¼]
ä¸€å¼µå¤§åœ–ï¼Œå…§å« 4 Ã— 3 çš„ 12 å€‹è¡¨æƒ…è²¼ã€‚èƒŒæ™¯ç´”ç¶ è‰² #00FF00ã€‚
å¼·èª¿ï¼šæ–‡å­—æ¸…æ™°ã€å¤§é ­ç‰¹å¯«ã€é©åˆå¾®ç¸®é¡¯ç¤ºã€‚
--ar 37:24 --v 6.0`;
    }
  };

  const handleCopy = () => {
    const text = generatePrompt();
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    textArea.style.top = "0";
    document.body.appendChild(textArea);
    try {
      textArea.focus();
      textArea.select();
      const successful = document.execCommand('copy');
      if (successful) {
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      } else {
        alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚");
      }
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
      alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½ã€‚");
    }
    document.body.removeChild(textArea);
  };

  const handlePhraseChange = (index, value) => {
    const newPhrases = [...phrases];
    newPhrases[index] = value;
    setPhrases(newPhrases);
  };

  const currentPool = currentCategories[activeCategory]?.pool || [];

  return (
    <div className={`w-full min-h-screen p-4 md:p-8 font-sans transition-colors duration-500 ${mode === 'sticker' ? 'bg-green-50' : 'bg-indigo-50'}`}>
      <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* å·¦å´ï¼šæ§åˆ¶é¢æ¿ */}
        <div className="bg-white rounded-2xl shadow-lg p-6 space-y-6">
          
          {/* é ‚éƒ¨ Header & æ¨¡å¼åˆ‡æ› */}
          <div className="border-b pb-4">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div className="flex items-center space-x-3">
                <div className={`p-2 rounded-lg text-white transition-colors ${mode === 'sticker' ? 'bg-green-500' : 'bg-indigo-500'}`}>
                  {mode === 'sticker' ? <Sticker size={24} /> : <Smile size={24} />}
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-gray-800">
                    {mode === 'sticker' ? 'Prompt ç”Ÿæˆå™¨' : 'Prompt ç”Ÿæˆå™¨'}
                  </h1>
                  <span className={`text-xs px-2 py-0.5 rounded font-medium ${mode === 'sticker' ? 'bg-green-100 text-green-700' : 'bg-indigo-100 text-indigo-700'}`}>
                     {mode === 'sticker' ? 'ä¸€èˆ¬è²¼åœ–æ¨¡å¼' : 'è¡¨æƒ…è²¼æ¨¡å¼'}
                  </span>
                </div>
              </div>
              
              {/* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */}
              <div className="flex bg-gray-100 p-1 rounded-xl">
                <button
                  onClick={() => setMode('sticker')}
                  className={`flex items-center px-4 py-2 rounded-lg text-sm font-bold transition-all ${
                    mode === 'sticker' 
                      ? 'bg-white text-green-600 shadow-sm' 
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  <Sticker size={16} className="mr-2" />
                  ä¸€èˆ¬è²¼åœ–
                </button>
                <button
                  onClick={() => setMode('emoji')}
                  className={`flex items-center px-4 py-2 rounded-lg text-sm font-bold transition-all ${
                    mode === 'emoji' 
                      ? 'bg-white text-indigo-600 shadow-sm' 
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  <Smile size={16} className="mr-2" />
                  è¡¨æƒ…è²¼
                </button>
              </div>
            </div>
            <p className="mt-3 text-xs text-gray-500">
              {mode === 'sticker' 
                ? 'ğŸŸ¢ è²¼åœ–æ¨¡å¼ï¼šç”Ÿæˆå«æ–‡å­—ã€å‹•ä½œè±å¯Œçš„å¤§è²¼åœ– (Sticker)' 
                : 'ğŸŸ£ è¡¨æƒ…è²¼æ¨¡å¼ï¼šç”Ÿæˆå¤§é ­ç‰¹å¯«ï¼Œä¸Šæ–¹æ­é…ç°¡å–®æ–‡å­— (Emoji)'}
            </p>
          </div>

          {/* é¢¨æ ¼èˆ‡èªè¨€ */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <label className="flex items-center text-sm font-semibold text-gray-700">
                <Palette size={16} className="mr-2 text-purple-500" />
                ç•«é¢¨é¸æ“‡
              </label>
              <select
                value={styleType}
                onChange={(e) => setStyleType(e.target.value)}
                className={`w-full p-2.5 border rounded-xl focus:ring-2 outline-none bg-white text-sm transition-colors ${
                  mode === 'sticker' 
                    ? 'border-gray-300 focus:ring-green-400' 
                    : 'border-indigo-200 focus:ring-indigo-400'
                }`}
              >
                {styleOptions.map((opt) => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
            <div className="space-y-2">
              <label className="flex items-center text-sm font-semibold text-gray-700">
                <Type size={16} className="mr-2 text-orange-500" />
                èªè¨€è¨­å®š
              </label>
              <select
                value={language}
                onChange={(e) => setLanguage(e.target.value)}
                className={`w-full p-2.5 border rounded-xl focus:ring-2 outline-none bg-white text-sm transition-colors ${
                  mode === 'sticker' 
                    ? 'border-gray-300 focus:ring-green-400' 
                    : 'border-indigo-200 focus:ring-indigo-400'
                }`}
              >
                <option value="å°ç£ç¹é«”ä¸­æ–‡">å°ç£ç¹é«”ä¸­æ–‡</option>
                <option value="English">English</option>
                <option value="Japanese">æ—¥æœ¬èª</option>
                <option value="Korean">í•œêµ­ì–´</option>
              </select>
            </div>
          </div>

          {/* å…§å®¹ç·¨è¼¯å€ (12æ ¼) */}
          <div className="space-y-3">
            <div className="flex justify-between items-center">
              <label className="flex items-center text-sm font-semibold text-gray-700">
                <LayoutGrid size={16} className={`mr-2 ${mode === 'sticker' ? 'text-green-600' : 'text-indigo-600'}`} />
                {mode === 'sticker' ? 'è²¼åœ–æ–‡å­— (12æ ¼)' : 'è¡¨æƒ…æ–‡å­— (12æ ¼)'}
              </label>
              <button 
                onClick={handleShuffleCurrent}
                className={`text-xs px-3 py-1 rounded-full flex items-center transition border ${
                  mode === 'sticker' 
                    ? 'bg-green-50 text-green-700 hover:bg-green-100 border-green-200' 
                    : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border-indigo-200'
                }`}
              >
                <Shuffle size={12} className="mr-1" /> éš¨æ©Ÿæ›ä¸€çµ„
              </button>
            </div>

            {/* å¿«é€Ÿå ´æ™¯é¸æ“‡æŒ‰éˆ• */}
            <div className="grid grid-cols-3 gap-2 mb-2">
              {Object.values(currentCategories).map((cat) => (
                <button
                  key={cat.id}
                  onClick={() => handleCategoryChange(cat.id)}
                  className={`flex items-center justify-center p-2 rounded-lg text-xs font-medium transition-all ${
                    activeCategory === cat.id 
                      ? (mode === 'sticker' ? 'bg-green-600 text-white shadow-md' : 'bg-indigo-600 text-white shadow-md')
                      : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'
                  }`}
                >
                  <span className="mr-1.5">{cat.icon}</span>
                  {cat.label}
                </button>
              ))}
            </div>
            
            {/* Datalist ç”¨æ–¼ä¸‹æ‹‰é¸å–® */}
            <datalist id="category-phrases">
              {currentPool.map((phrase, idx) => (
                <option key={idx} value={phrase} />
              ))}
            </datalist>

            <div className="grid grid-cols-3 gap-3">
              {phrases.map((phrase, index) => (
                <div key={index} className="relative group">
                   <input
                    type="text"
                    value={phrase}
                    onChange={(e) => handlePhraseChange(index, e.target.value)}
                    list="category-phrases" 
                    className={`w-full p-2 text-center text-sm border rounded-lg outline-none focus:ring-1 transition ${
                      mode === 'sticker'
                        ? 'border-gray-200 focus:border-green-400 focus:ring-green-400'
                        : 'border-indigo-100 focus:border-indigo-400 focus:ring-indigo-400 bg-indigo-50/30'
                    }`}
                    placeholder={mode === 'sticker' ? `è²¼åœ– ${index + 1}` : `è¡¨æƒ… ${index + 1}`}
                  />
                  <div className="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-300 group-hover:text-gray-400">
                    <ChevronDown size={12} />
                  </div>
                </div>
              ))}
            </div>
            <p className="text-xs text-gray-400 text-center mt-1">
                ğŸ’¡ é»æ“Šè¼¸å…¥æ¡†å³å´å¯é¸æ“‡æ›´å¤š {
                  currentCategories[activeCategory]?.label
                } ç”¨èª
            </p>
          </div>
        </div>

        {/* å³å´ï¼šé è¦½èˆ‡è¼¸å‡º */}
        <div className="flex flex-col space-y-6">
          
          {/* é è¦½å¡ç‰‡ */}
          <div className={`bg-white rounded-2xl shadow-lg p-6 flex flex-col h-full border-t-4 transition-colors ${
            mode === 'sticker' ? 'border-green-500' : 'border-indigo-500'
          }`}>
            <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
              <div className="flex items-center">
                <Terminal size={20} className="mr-2" />
                ç”Ÿæˆçš„ Prompt
              </div>
              <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Midjourney / DALL-E</span>
            </h2>
            
            <div className="flex-grow bg-gray-900 text-gray-100 p-4 rounded-xl font-mono text-sm overflow-y-auto whitespace-pre-wrap leading-relaxed relative group border border-gray-800 shadow-inner">
              {generatePrompt()}
            </div>

            <div className="mt-6 flex flex-col space-y-3">
              <button
                onClick={handleCopy}
                className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center transition-all duration-200 shadow-md transform hover:-translate-y-1 ${
                  mode === 'sticker'
                    ? (copied ? "bg-green-600 text-white" : "bg-green-500 hover:bg-green-600 text-white")
                    : (copied ? "bg-indigo-600 text-white" : "bg-indigo-500 hover:bg-indigo-600 text-white")
                }`}
              >
                {copied ? (
                  <>
                    <Check size={24} className="mr-2" /> å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿
                  </>
                ) : (
                  <>
                    <Copy size={24} className="mr-2" /> è¤‡è£½ Prompt
                  </>
                )}
              </button>
              
              <div className={`text-xs p-3 rounded-lg leading-relaxed border ${
                mode === 'sticker' 
                  ? 'bg-yellow-50 text-yellow-800 border-yellow-100'
                  : 'bg-indigo-50 text-indigo-800 border-indigo-100'
              }`}>
                <strong>ğŸ“ è²¼å¿ƒæé†’ï¼š</strong>
                <ul className="list-disc list-inside mt-1 space-y-1">
                  <li>è¤‡è£½ Prompt å¾Œï¼Œè«‹åˆ° AI å·¥å…·ï¼ˆå¦‚ Midjourneyï¼‰ä¸Šå‚³ä½ çš„è§’è‰²åœ–ç‰‡ä¸¦è²¼ä¸Š Promptã€‚</li>
                  <li>ç”Ÿæˆæ»¿æ„çš„ 4x3 ç¶²æ ¼åœ–å¾Œï¼Œè«‹ä¸‹è¼‰è©²åœ–ç‰‡ã€‚</li>
                  {mode === 'emoji' && (
                    <li>âš ï¸ <strong>è¡¨æƒ…è²¼æ¨¡å¼</strong>å·²èª¿æ•´ç‚ºã€Œå¤§é ­ç‰¹å¯« + ä¸Šæ–¹æ–‡å­—ã€é¢¨æ ¼ã€‚</li>
                  )}
                  <li><strong>ä¸‹ä¸€æ­¥ï¼š</strong>é»æ“Šä¸Šæ–¹ã€Œåˆ‡åœ–å»èƒŒã€é ç±¤ï¼Œå°‡è©²åœ–ç‰‡ä¸Šå‚³é€²è¡Œè™•ç†ã€‚</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
};


// ==========================================
// Part 2: Image Splitter Component
// ==========================================
const ImageSplitter = ({ mode, setMode }) => {
  const [originalImage, setOriginalImage] = useState(null);
  const [stickers, setStickers] = useState([]);
  
  // Settings State
  const [enableSmartRemove, setEnableSmartRemove] = useState(true);
  
  // Processing Parameters
  const [cropScale, setCropScale] = useState(0); // 0-50%
  const [targetColor, setTargetColor] = useState('#00FF00');
  const [tolerance, setTolerance] = useState(30);
  const [smoothness, setSmoothness] = useState(2);
  const [despill, setDespill] = useState(true);

  // Export Settings
  const [filePrefix, setFilePrefix] = useState('sticker');
  const [startNumber, setStartNumber] = useState('01');
  const [isZipping, setIsZipping] = useState(false);

  // Configuration Constants based on Mode
  const CONFIG = useMemo(() => {
    if (mode === 'emoji') {
      return {
        id: 'emoji',
        label: 'LINE è¡¨æƒ…è²¼ (Emoji)',
        totalW: 720,  // 180 * 4
        totalH: 540,  // 180 * 3
        cols: 4,
        rows: 3,
        cellW: 180,
        cellH: 180,
        desc: '180x180px (å›ºå®š)',
        uploadHint: '720x540px'
      };
    }
    return {
      id: 'sticker',
      label: 'LINE ä¸€èˆ¬è²¼åœ–',
      totalW: 1480, // 370 * 4
      totalH: 960,  // 320 * 3
      cols: 4,
      rows: 3,
      cellW: 370,
      cellH: 320,
      desc: '370x320px (æœ€å¤§)',
      uploadHint: '1480x960px'
    };
  }, [mode]);

  // Update default filename prefix when mode changes
  useEffect(() => {
    setFilePrefix(mode === 'emoji' ? 'emoji' : 'sticker');
  }, [mode]);

  // Load JSZip dynamically
  useEffect(() => {
    if (window.JSZip) return; 
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
    script.async = true;
    document.body.appendChild(script);
    return () => {
      if (document.body.contains(script)) {
        document.body.removeChild(script);
      }
    }
  }, []);

  const formatNumber = (startStr, index) => {
    const num = parseInt(startStr, 10);
    if (isNaN(num)) return (1 + index).toString();
    const currentVal = num + index;
    return currentVal.toString().padStart(startStr.length, '0');
  };

  const hexToRgb = (hex) => {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : { r: 0, g: 255, b: 0 };
  };

  // Handle Mode Switching (Resets workspace)
  const handleModeChange = (newMode) => {
    if (stickers.length > 0) {
      if (!window.confirm("åˆ‡æ›æ¨¡å¼å°‡æœƒæ¸…é™¤ç›®å‰çš„å·¥ä½œå€ï¼Œç¢ºå®šè¦åˆ‡æ›å—ï¼Ÿ")) return;
    }
    setMode(newMode);
    setStickers([]);
    setOriginalImage(null);
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload = () => {
        setOriginalImage(img);
        // Pass the img directly to slice to avoid closure stale state issues
        const initialStickers = sliceImage(img, CONFIG); 
        setStickers(initialStickers);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
    e.target.value = ''; // Reset input
  };

  // 1. Slice the image into grid
  const sliceImage = (img, currentConfig) => {
    const canvas = document.createElement('canvas');
    canvas.width = currentConfig.totalW;
    canvas.height = currentConfig.totalH;
    const ctx = canvas.getContext('2d');
    
    // Draw and scale image to fit the expected total size
    ctx.drawImage(img, 0, 0, currentConfig.totalW, currentConfig.totalH);

    const newStickers = [];
    for (let row = 0; row < currentConfig.rows; row++) {
      for (let col = 0; col < currentConfig.cols; col++) {
        const sx = col * currentConfig.cellW;
        const sy = row * currentConfig.cellH;
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = currentConfig.cellW;
        tempCanvas.height = currentConfig.cellH;
        const tempCtx = tempCanvas.getContext('2d');
        const rawData = ctx.getImageData(sx, sy, currentConfig.cellW, currentConfig.cellH);
        tempCtx.putImageData(rawData, 0, 0);

        newStickers.push({
          id: row * currentConfig.cols + col,
          sourceCanvas: tempCanvas,
          processedUrl: tempCanvas.toDataURL()
        });
      }
    }
    return newStickers;
  };

  // 2. Process a single sticker
  const processStickerData = useCallback((sourceCanvas) => {
    if (!enableSmartRemove) return sourceCanvas.toDataURL();

    const w = CONFIG.cellW;
    const h = CONFIG.cellH;
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');

    const scale = 1 + (cropScale / 100 * 0.2); 
    const dw = w * scale;
    const dh = h * scale;
    const dx = (w - dw) / 2;
    const dy = (h - dh) / 2;

    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(sourceCanvas, dx, dy, dw, dh);

    const imgData = ctx.getImageData(0, 0, w, h);
    const data = imgData.data;
    const { r: tr, g: tg, b: tb } = hexToRgb(targetColor);
    
    const tol = tolerance * 4.4; 
    const smooth = Math.max(0.1, smoothness * 2);

    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];
      
      const dist = Math.sqrt(
        (r - tr) * (r - tr) + 
        (g - tg) * (g - tg) + 
        (b - tb) * (b - tb)
      );

      let alpha = 255;

      if (dist < tol) {
        alpha = 0;
      } else if (dist < tol + smooth) {
        alpha = ((dist - tol) / smooth) * 255;
      }

      data[i + 3] = alpha;

      if (despill && alpha > 0) {
        if (tg > tr && tg > tb) {
          const limit = (r + b) / 2;
          if (g > limit) data[i + 1] = limit;
        }
        else if (tb > tr && tb > tg) {
          const limit = (r + g) / 2;
          if (b > limit) data[i + 2] = limit;
        }
          else if (tr > tg && tr > tb) {
            const limit = (g + b) / 2;
            if (r > limit) data[i] = limit;
          }
      }
    }

    ctx.putImageData(imgData, 0, 0);
    return canvas.toDataURL();
  }, [enableSmartRemove, cropScale, targetColor, tolerance, smoothness, despill, CONFIG]);

  useEffect(() => {
    if (!originalImage || stickers.length === 0) return;

    const timer = setTimeout(() => {
      setStickers(prev => prev.map(s => ({
        ...s,
        processedUrl: processStickerData(s.sourceCanvas)
      })));
    }, 50);

    return () => clearTimeout(timer);
  }, [processStickerData, originalImage]);

  const handleDownloadSingle = (dataUrl, index) => {
    const fileName = `${filePrefix}_${formatNumber(startNumber, index)}.png`;
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleBatchDownload = async () => {
    if (!window.JSZip) {
      alert("ç³»çµ±æ­£åœ¨è¼‰å…¥æ‰“åŒ…å…ƒä»¶ï¼Œè«‹ç¨å¾Œå†è©¦...");
      return;
    }

    setIsZipping(true);
    const zip = new window.JSZip();
    const folder = zip.folder(`${filePrefix}_pack`);

    stickers.forEach((sticker, index) => {
      const base64Data = sticker.processedUrl.split(',')[1];
      const fileName = `${filePrefix}_${formatNumber(startNumber, index)}.png`;
      folder.file(fileName, base64Data, { base64: true });
    });

    try {
      const content = await zip.generateAsync({ type: "blob" });
      const url = URL.createObjectURL(content);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${filePrefix}_pack.zip`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error("ZIP Generation failed:", err);
      alert("æ‰“åŒ…å¤±æ•—ï¼Œè«‹é‡è©¦");
    } finally {
      setIsZipping(false);
    }
  };

  const handlePreset = (type) => {
    if (type === 'black') {
      setTargetColor('#000000');
      setTolerance(30);
      setDespill(false);
    } else if (type === 'green') {
      setTargetColor('#00FF00');
      setTolerance(30);
      setDespill(true);
    }
  };

  const pickColorFromSticker = (e, sticker) => {
    if (!sticker) return;
    const rect = e.target.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width * CONFIG.cellW;
    const y = (e.clientY - rect.top) / rect.height * CONFIG.cellH;
    
    const ctx = sticker.sourceCanvas.getContext('2d');
    const p = ctx.getImageData(x, y, 1, 1).data;
    
    const hex = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1).toUpperCase();
    setTargetColor(hex);
  };

  return (
    <div className="w-full min-h-screen bg-[#0b0c15] p-4 md:p-8 font-sans text-slate-200">
      <div className="max-w-[1400px] mx-auto">
        
        {/* Header */}
        <div className="bg-[#151926] rounded-2xl shadow-xl p-6 mb-8 border border-slate-800/60 flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden group">
          {/* Neon Accent based on mode */}
          <div className={`absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r opacity-70 transition-colors duration-500 ${mode === 'emoji' ? 'from-yellow-400 via-orange-500 to-red-500' : 'from-indigo-500 via-purple-500 to-pink-500'}`}></div>
          
          <div className="relative z-10">
            <h1 className="text-3xl font-bold flex items-center gap-3 text-white tracking-tight">
              <div className={`p-2 rounded-lg shadow-lg transition-colors duration-500 ${mode === 'emoji' ? 'bg-orange-500 shadow-orange-500/20' : 'bg-indigo-600 shadow-indigo-500/20'}`}>
                {mode === 'emoji' ? <Smile className="w-6 h-6 text-white" /> : <Scissors className="w-6 h-6 text-white" />}
              </div>
              Sticker Splitter <span className={`${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'} font-light transition-colors duration-500`}>Pro</span>
            </h1>
            <p className="text-slate-400 text-sm mt-2 flex items-center gap-2">
              <Sparkles className="w-3 h-3 text-yellow-400" />
              è‡ªå‹•åŒ– 4x3 ç¶²æ ¼åˆ†å‰² â€¢ æ™ºèƒ½å»èƒŒ â€¢ <span className={`font-medium ${mode === 'emoji' ? 'text-orange-300' : 'text-indigo-300'}`}>{CONFIG.label}æ¨¡å¼</span>
            </p>
          </div>
          
          {/* Mode Switcher & Actions */}
          <div className="flex gap-4 relative z-10 items-center">
            {/* Toggle Switch */}
            <div className="bg-[#0f1117] p-1 rounded-xl border border-slate-700 flex relative">
               <button 
                 onClick={() => handleModeChange('sticker')}
                 className={`relative z-10 px-4 py-2 rounded-lg text-xs font-medium transition-all flex items-center gap-2 ${mode === 'sticker' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}
               >
                 <Sticker className="w-3 h-3" />
                 ä¸€èˆ¬è²¼åœ–
               </button>
               <button 
                 onClick={() => handleModeChange('emoji')}
                 className={`relative z-10 px-4 py-2 rounded-lg text-xs font-medium transition-all flex items-center gap-2 ${mode === 'emoji' ? 'bg-orange-500 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}
               >
                 <Smile className="w-3 h-3" />
                 è¡¨æƒ…è²¼
               </button>
            </div>

            {stickers.length > 0 && (
              <button 
                onClick={() => {setStickers([]); setOriginalImage(null);}}
                className="flex items-center gap-2 px-4 py-2.5 text-slate-300 bg-[#1e2336] hover:bg-[#252b42] border border-slate-700 hover:border-slate-600 rounded-xl transition-all shadow-lg shadow-black/20 text-xs font-medium"
              >
                <RefreshCw className="w-3 h-3" />
                é‡æ–°é–‹å§‹
              </button>
            )}
          </div>
        </div>

        {/* Workspace */}
        {stickers.length > 0 ? (
          <div className="grid lg:grid-cols-12 gap-8">
            
            {/* Left: Control Panels */}
            <div className="lg:col-span-3 lg:col-start-1 space-y-6">
              
              {/* Image Settings */}
              <div className="bg-[#151926] text-gray-200 rounded-2xl shadow-xl border border-slate-800/60 overflow-hidden">
                <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-[#1a2030]">
                  <h2 className={`font-bold text-lg flex items-center gap-2 transition-colors ${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'}`}>
                    <Settings className="w-5 h-5" />
                    å»èƒŒåƒæ•¸
                  </h2>
                  <div 
                    className={`w-12 h-6 rounded-full p-1 cursor-pointer transition-all duration-300 ${enableSmartRemove ? (mode === 'emoji' ? 'bg-orange-500' : 'bg-indigo-600') + ' shadow-inner' : 'bg-slate-700'}`}
                    onClick={() => setEnableSmartRemove(!enableSmartRemove)}
                  >
                    <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${enableSmartRemove ? 'translate-x-6' : 'translate-x-0'}`}></div>
                  </div>
                </div>

                {enableSmartRemove && (
                  <div className="p-5 space-y-7">
                    {/* Presets */}
                    <div>
                      <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-3 block">å¿«é€Ÿè¨­å®š (Presets)</label>
                      <div className="grid grid-cols-2 gap-3">
                        <button 
                          onClick={() => handlePreset('black')}
                          className={`flex flex-col items-center justify-center p-3 rounded-xl bg-[#0f1117] border border-slate-700 hover:shadow-lg transition-all group ${mode === 'emoji' ? 'hover:border-orange-500 hover:shadow-orange-500/10' : 'hover:border-indigo-500 hover:shadow-indigo-500/10'}`}
                        >
                          <div className="w-6 h-6 rounded-full bg-black border border-slate-600 mb-2 group-hover:scale-110 transition"></div>
                          <span className="text-xs text-slate-300 group-hover:text-white">é»‘åº•å»èƒŒ</span>
                        </button>
                        <button 
                           onClick={() => handlePreset('green')}
                           className="flex flex-col items-center justify-center p-3 rounded-xl bg-[#0f1117] border border-slate-700 hover:border-green-500 hover:shadow-green-500/10 transition-all group"
                        >
                          <div className="w-6 h-6 rounded-full bg-green-500 mb-2 group-hover:scale-110 transition"></div>
                          <span className="text-xs text-slate-300 group-hover:text-white">ç¶ å¹•å»èƒŒ</span>
                        </button>
                      </div>
                    </div>

                    {/* Controls */}
                    <div className="space-y-6">
                      {/* Crop Scale */}
                      <div className="bg-[#0f1117] p-4 rounded-xl border border-slate-800">
                        <div className="flex justify-between text-xs mb-3">
                          <span className="text-slate-400 flex items-center gap-1 font-medium"><Layers className="w-3 h-3"/> è£åˆ‡ç¸®æ”¾ (é»‘é‚Š)</span>
                          <span className={`font-mono ${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'}`}>{cropScale}%</span>
                        </div>
                        <input
                          type="range"
                          min="0"
                          max="50"
                          value={cropScale}
                          onChange={(e) => setCropScale(Number(e.target.value))}
                          className={`w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer hover:opacity-100 ${mode === 'emoji' ? 'accent-orange-500' : 'accent-indigo-500'}`}
                        />
                      </div>

                      {/* Target Color */}
                      <div className="bg-[#0f1117] p-4 rounded-xl border border-slate-800">
                          <div className="flex justify-between items-center mb-3">
                            <span className="text-xs text-slate-400 font-medium">ç›®æ¨™é¡è‰² (å»èƒŒè‰²)</span>
                            <span className="text-xs font-mono text-slate-500">{targetColor}</span>
                          </div>
                          <div className="flex gap-3">
                            <div className={`relative flex-1 h-9 rounded-lg overflow-hidden border border-slate-700 ring-2 ring-transparent transition-all ${mode === 'emoji' ? 'hover:ring-orange-500/50' : 'hover:ring-indigo-500/50'}`}>
                                <input 
                                  type="color" 
                                  value={targetColor}
                                  onChange={(e) => setTargetColor(e.target.value)}
                                  className="absolute -top-2 -left-2 w-[150%] h-[150%] cursor-pointer bg-transparent" 
                                />
                            </div>
                            <div className="h-9 w-9 flex items-center justify-center bg-slate-800 border border-slate-700 rounded-lg cursor-help hover:bg-slate-700 text-slate-400 hover:text-white transition" title="é»æ“Šå³å´è²¼åœ–å¯ç›´æ¥å¸å–é¡è‰²">
                              <Droplet className="w-4 h-4" />
                            </div>
                          </div>
                      </div>

                      {/* Tolerance */}
                      <div>
                        <div className="flex justify-between text-xs mb-2">
                          <span className="text-slate-400 font-medium">è‰²å½©å®¹è¨±åº¦</span>
                          <span className={`font-mono ${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'}`}>{tolerance}</span>
                        </div>
                        <input
                          type="range"
                          min="1"
                          max="100"
                          value={tolerance}
                          onChange={(e) => setTolerance(Number(e.target.value))}
                          className={`w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer hover:opacity-100 ${mode === 'emoji' ? 'accent-orange-500' : 'accent-indigo-500'}`}
                        />
                      </div>

                      {/* Smoothness */}
                      <div>
                        <div className="flex justify-between text-xs mb-2">
                          <span className="text-slate-400 font-medium">é‚Šç·£æŸ”åŒ–</span>
                          <span className={`font-mono ${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'}`}>{smoothness}</span>
                        </div>
                        <input
                          type="range"
                          min="0"
                          max="20"
                          value={smoothness}
                          onChange={(e) => setSmoothness(Number(e.target.value))}
                          className={`w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer hover:opacity-100 ${mode === 'emoji' ? 'accent-orange-500' : 'accent-indigo-500'}`}
                        />
                      </div>

                      {/* Despill */}
                      <div className="flex items-center justify-between pt-4 border-t border-slate-800">
                          <span className="text-sm text-slate-300 font-medium">æº¢è‰²å»é™¤ (Despill)</span>
                          <div 
                            className={`w-10 h-5 rounded-full p-0.5 cursor-pointer transition-colors ${despill ? (mode === 'emoji' ? 'bg-orange-500' : 'bg-indigo-600') : 'bg-slate-700'}`}
                            onClick={() => setDespill(!despill)}
                          >
                            <div className={`w-4 h-4 bg-white rounded-full shadow transform transition-transform ${despill ? 'translate-x-5' : 'translate-x-0'}`}></div>
                          </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Export Settings Panel */}
              <div className="bg-[#151926] rounded-2xl shadow-xl border border-slate-800/60 overflow-hidden">
                <div className="p-4 bg-[#1a2030] border-b border-slate-800">
                  <h3 className={`font-bold flex items-center gap-2 text-sm ${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'}`}>
                    <Package className="w-4 h-4" />
                    åŒ¯å‡ºè¨­å®š
                  </h3>
                </div>
                <div className="p-5 space-y-5">
                  {/* Filename Prefix */}
                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-1.5 flex items-center gap-1">
                      <FileText className="w-3 h-3" /> æª”åå‰ç¶´
                    </label>
                    <input 
                      type="text" 
                      value={filePrefix}
                      onChange={(e) => setFilePrefix(e.target.value)}
                      className="w-full px-3 py-2.5 text-sm bg-[#0f1117] border border-slate-700 rounded-lg text-slate-200 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                      placeholder="sticker"
                    />
                  </div>

                  {/* Start Number */}
                  <div>
                    <label className="text-xs font-semibold text-slate-500 mb-1.5 flex items-center gap-1">
                      <Hash className="w-3 h-3" /> èµ·å§‹ç·¨è™Ÿ
                    </label>
                    <input 
                      type="text" 
                      inputMode="numeric"
                      pattern="[0-9]*"
                      value={startNumber}
                      onChange={(e) => setStartNumber(e.target.value)}
                      className="w-full px-3 py-2.5 text-sm bg-[#0f1117] border border-slate-700 rounded-lg text-slate-200 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 outline-none font-mono"
                      placeholder="01"
                    />
                    <p className="text-[10px] text-slate-600 mt-1.5">
                      ç¯„ä¾‹ï¼šè¼¸å…¥ "01" â†’ 01, 02...
                    </p>
                  </div>

                  {/* Preview Filename */}
                  <div className="text-xs text-slate-400 bg-[#0f1117] p-3 rounded-lg border border-slate-800/50 flex justify-between items-center">
                    <span>é è¦½ï¼š</span>
                    <span className={`font-mono ${mode === 'emoji' ? 'text-orange-300' : 'text-indigo-300'}`}>{filePrefix}_{formatNumber(startNumber, 0)}.png</span>
                  </div>

                  {/* Batch Download Button */}
                  <button 
                    onClick={handleBatchDownload}
                    disabled={isZipping}
                    className={`w-full flex items-center justify-center gap-2 text-white py-3 rounded-xl text-sm font-bold transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-[0.98]
                      ${mode === 'emoji' 
                        ? 'bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-400 hover:to-red-400 shadow-orange-900/20' 
                        : 'bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 shadow-indigo-900/20'}`}
                  >
                    {isZipping ? (
                      <>
                        <RefreshCw className="w-4 h-4 animate-spin" />
                        æ‰“åŒ…ä¸­...
                      </>
                    ) : (
                      <>
                        <Download className="w-4 h-4" />
                        ä¸‹è¼‰å…¨éƒ¨è²¼åœ– (.ZIP)
                      </>
                    )}
                  </button>
                </div>
              </div>

            </div>

            {/* Right: Preview Grid */}
            <div className="lg:col-span-9">
              {/* Info Bar */}
              <div className="mb-4 flex items-center gap-2 text-xs text-slate-400 bg-[#151926] py-2 px-4 rounded-lg border border-slate-800 w-fit">
                <span className={`w-2 h-2 rounded-full ${mode === 'emoji' ? 'bg-orange-500' : 'bg-indigo-500'}`}></span>
                ç›®å‰æ¨¡å¼ï¼š<span className="text-slate-200 font-medium">{CONFIG.label}</span>
                <span className="mx-1 opacity-30">|</span>
                å–®å¼µå°ºå¯¸ï¼š<span className="font-mono text-slate-300">{CONFIG.cellW}x{CONFIG.cellH}px</span>
              </div>

              <div className="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5">
                {stickers.map((sticker, index) => (
                  <div key={sticker.id} className={`group relative bg-[#151926] rounded-2xl shadow-lg border border-slate-800 overflow-hidden transition-all duration-300 ${mode === 'emoji' ? 'hover:border-orange-500/50 hover:shadow-orange-500/10' : 'hover:border-indigo-500/50 hover:shadow-indigo-500/10'}`}>
                    
                    {/* Header */}
                    <div className="flex justify-between items-center p-2.5 bg-[#1a2030] border-b border-slate-800/50 text-[10px] text-slate-400 uppercase tracking-wider font-semibold">
                      <span>#{index + 1}</span>
                      <span className={`font-mono ${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'}`}>{filePrefix}_{formatNumber(startNumber, index)}.png</span>
                    </div>

                    {/* Canvas Area */}
                    <div 
                      className={`relative aspect-[${CONFIG.cellW}/${CONFIG.cellH}] bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] bg-[#0f1117] cursor-crosshair overflow-hidden`}
                      title="é»æ“Šå¸å–æ­¤é¡è‰²ç‚ºç›®æ¨™é¡è‰²"
                      style={{ aspectRatio: `${CONFIG.cellW}/${CONFIG.cellH}` }}
                    >
                      {/* Checkered pattern for dark mode */}
                      <div className="absolute inset-0 opacity-10 pointer-events-none" 
                           style={{backgroundImage: 'linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(-45deg, #444 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #444 75%), linear-gradient(-45deg, transparent 75%, #444 75%)', backgroundSize: '20px 20px', backgroundPosition: '0 0, 0 10px, 10px -10px, -10px 0px'}}>
                      </div>
                      
                      <img 
                        src={sticker.processedUrl} 
                        onClick={(e) => pickColorFromSticker(e, sticker)}
                        className="relative z-10 w-full h-full object-contain transition-transform duration-300 group-hover:scale-105"
                        alt={`Sticker ${index + 1}`}
                      />

                      {/* Hover Overlay */}
                      <div className={`absolute inset-0 transition-colors pointer-events-none z-20 ${mode === 'emoji' ? 'bg-orange-500/0 group-hover:bg-orange-500/5' : 'bg-indigo-500/0 group-hover:bg-indigo-500/5'}`}></div>
                    </div>

                    {/* Action */}
                    <div className="p-3 bg-[#151926] border-t border-slate-800 flex justify-center">
                       <button 
                         onClick={() => handleDownloadSingle(sticker.processedUrl, index)}
                         className={`flex items-center gap-1.5 px-4 py-2 rounded-lg text-xs font-medium text-slate-400 bg-slate-800 hover:text-white transition-all w-full justify-center ${mode === 'emoji' ? 'hover:bg-orange-600' : 'hover:bg-indigo-600'}`}
                       >
                         <Download className="w-3 h-3" />
                         å–®å¼µä¸‹è¼‰
                       </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        ) : (
          // Optimized Empty State / Hero Section
          <div className={`relative border border-slate-800 rounded-3xl p-12 md:p-24 text-center bg-[#151926]/40 flex flex-col items-center justify-center min-h-[600px] transition-all duration-500 group overflow-hidden ${mode === 'emoji' ? 'hover:border-orange-500/30' : 'hover:border-indigo-500/30'}`}>
            
            {/* Background Decorations */}
            <div className={`absolute inset-0 bg-gradient-to-b from-transparent to-transparent pointer-events-none transition-colors duration-500 ${mode === 'emoji' ? 'via-orange-900/5' : 'via-indigo-900/5'}`}></div>
            <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] blur-[100px] rounded-full pointer-events-none transition-colors duration-500 ${mode === 'emoji' ? 'bg-orange-500/10' : 'bg-indigo-500/10'}`}></div>

            <div className="relative z-10 flex flex-col items-center animate-in fade-in zoom-in duration-500">
                <div className={`w-28 h-28 bg-[#1e2336] rounded-3xl flex items-center justify-center mb-8 group-hover:scale-110 group-hover:rotate-3 transition-all duration-500 shadow-2xl border border-slate-700/50 ${mode === 'emoji' ? 'group-hover:border-orange-500/50' : 'group-hover:border-indigo-500/50'}`}>
                   {mode === 'emoji' ? 
                     <Smile className={`w-12 h-12 transition-colors ${mode === 'emoji' ? 'text-orange-500 group-hover:text-orange-400' : 'text-slate-500'}`} /> : 
                     <LayoutGrid className={`w-12 h-12 transition-colors ${mode === 'sticker' ? 'text-indigo-500 group-hover:text-indigo-400' : 'text-slate-500'}`} />
                   }
                </div>
                
                <h3 className="text-3xl md:text-4xl font-bold text-white mb-6 tracking-tight">
                  ä¸Šå‚³æ‚¨çš„ <span className={`text-transparent bg-clip-text bg-gradient-to-r ${mode === 'emoji' ? 'from-orange-400 to-red-400' : 'from-indigo-400 to-purple-400'}`}>{CONFIG.label}</span> ç¶²æ ¼åœ–
                </h3>
                
                <p className="text-slate-400 max-w-lg mx-auto mb-12 text-lg leading-relaxed font-light">
                  å»ºè­°å°ºå¯¸ï¼š<span className="text-slate-300 font-mono bg-slate-800/50 px-2 py-0.5 rounded">{CONFIG.uploadHint}</span> (4x3 ç¶²æ ¼)
                  <br/>å–®æ ¼å°‡è‡ªå‹•è£åˆ‡ç‚º <span className={`font-medium ${mode === 'emoji' ? 'text-orange-400' : 'text-indigo-400'}`}>{CONFIG.cellW}x{CONFIG.cellH}px</span>
                </p>
                
                <label className={`group/btn flex items-center gap-4 px-12 py-5 text-white rounded-2xl cursor-pointer transition-all shadow-xl font-bold text-xl hover:-translate-y-1 ring-1 ring-white/10
                  ${mode === 'emoji' 
                    ? 'bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 shadow-orange-900/30 hover:shadow-orange-500/30' 
                    : 'bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 shadow-indigo-900/30 hover:shadow-indigo-500/30'}`}>
                   <Upload className="w-7 h-7 group-hover/btn:animate-bounce" />
                   <span>é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</span>
                   <input 
                     type="file" 
                     accept="image/*" 
                     onChange={handleImageUpload} 
                     className="hidden" 
                   />
                 </label>
                 
                 <p className="mt-6 text-sm text-slate-500">æ”¯æ´ PNG, JPG æ ¼å¼</p>
            </div>
          </div>
        )}

      </div>
    </div>
  );
};

// ==========================================
// Main App Component
// ==========================================
export default function App() {
  const [activeTab, setActiveTab] = useState('generator'); // 'generator' | 'splitter'
  const [globalMode, setGlobalMode] = useState('sticker'); // 'sticker' | 'emoji'

  return (
    <div className="flex flex-col min-h-screen font-sans">
      
      {/* Top Navigation Bar */}
      <nav className="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex items-center">
              <span className="text-xl font-black bg-gradient-to-r from-green-500 to-indigo-600 bg-clip-text text-transparent mr-6">
                LINE Sticker Maker
              </span>
              <div className="hidden sm:flex space-x-4">
                <button
                  onClick={() => setActiveTab('generator')}
                  className={`px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${
                    activeTab === 'generator'
                      ? 'bg-green-50 text-green-700'
                      : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                  }`}
                >
                  <Wand2 size={18} />
                  ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå’’èª
                </button>
                <button
                  onClick={() => setActiveTab('splitter')}
                  className={`px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${
                    activeTab === 'splitter'
                      ? 'bg-indigo-50 text-indigo-700'
                      : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                  }`}
                >
                  <Scissors size={18} />
                  ç¬¬äºŒæ­¥ï¼šåˆ‡åœ–å»èƒŒ
                </button>
              </div>
            </div>
            <div className="flex items-center">
              <span className="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">v2.0 Integrated</span>
            </div>
          </div>
        </div>
        
        {/* Mobile Nav */}
        <div className="sm:hidden flex border-t border-gray-100">
           <button
              onClick={() => setActiveTab('generator')}
              className={`flex-1 py-3 text-xs font-medium flex justify-center items-center gap-2 ${
                activeTab === 'generator' ? 'bg-green-50 text-green-700' : 'text-gray-500'
              }`}
            >
              <Wand2 size={16} /> ç”Ÿæˆå’’èª
            </button>
            <button
              onClick={() => setActiveTab('splitter')}
              className={`flex-1 py-3 text-xs font-medium flex justify-center items-center gap-2 ${
                activeTab === 'splitter' ? 'bg-indigo-50 text-indigo-700' : 'text-gray-500'
              }`}
            >
              <Scissors size={16} /> åˆ‡åœ–å»èƒŒ
            </button>
        </div>
      </nav>

      {/* Main Content Area */}
      <main className="flex-grow bg-gray-50">
        {activeTab === 'generator' ? (
          <PromptGenerator mode={globalMode} setMode={setGlobalMode} />
        ) : (
          <ImageSplitter mode={globalMode} setMode={setGlobalMode} />
        )}
      </main>

    </div>
  );
}
